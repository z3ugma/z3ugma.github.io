<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

<!--Facebook share tags -->
  <meta property="og:url"                content="/2014/02/09/using-python-to-pay-parking-tickets/" />
  <meta property="og:type"               content="article" />
  <meta property="og:title"              content="Using Python to Pay Parking Tickets"/>
  <meta property="og:description"        content="" />
  <meta property="og:image"              content="" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Using Python to Pay Parking Tickets
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Ubuntu">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/f_favicon.png">
                                 <link rel="shortcut icon" href="/public/f_favicon.png">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0d">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
          <img src="https://avatars1.githubusercontent.com/u/6099983?v=3&s=460" height="200"/>
      <h1>
        <a href="/">
          Python Monty
        </a>
      </h1>
      <p class="lead">Explaining the terrible code I write as I go. Mostly in Python. Also some restaurant reviews and recipes.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive/">Archive</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    </nav>

    <p>&copy; 2018. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Using Python to Pay Parking Tickets</h1>
  <span class="post-date">09 Feb 2014</span>
  <p>##Using Python to Pay Parking Tickets ##</p>

<p>An enterprising fellow from Milwaukee built a site to automatically pay parking tickets in his city and in Madison. Unfortunately, the city of Madison changed around their ticket-payment website, so the site is not working. I thought it would be a good programing challenge for me.</p>

<h3 id="how-do-you-work-with-web-services-when-they-have-no-api">How Do You Work with Web Services When They Have No API?</h3>

<p>Since the City of Madison doesn’t have an API on their website, it’s not a simple matter of sending a query and getting back a nicely-formatted JSON response to use in my app. So how can I get the information that I need from the website?</p>

<p>Fortunately, all websites have at least one available point of entry - via the web, as a user! There’s a Python package to emulate user behavior in a browser and return the HTTP response, which we can further manipulate as we want.</p>

<p>This is <a href="https://pypi.python.org/pypi/mechanize/">Mechanize</a>, originally developed for Perl. I install the Python package and make a script to go to the City of Madison’s parking ticket payment site at https://www.cityofmadison.com/epayment/parkingTicket/. I based this on an example at http://stockrt.github.io/p/emulating-a-browser-in-python-with-mechanize/.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">mechanize</span>
<span class="kn">import</span> <span class="nn">cookielib</span>

<span class="c"># Browser</span>
<span class="n">br</span> <span class="o">=</span> <span class="n">mechanize</span><span class="o">.</span><span class="n">Browser</span><span class="p">()</span>

<span class="c"># Cookie Jar</span>
<span class="n">cj</span> <span class="o">=</span> <span class="n">cookielib</span><span class="o">.</span><span class="n">LWPCookieJar</span><span class="p">()</span>
<span class="n">br</span><span class="o">.</span><span class="n">set_cookiejar</span><span class="p">(</span><span class="n">cj</span><span class="p">)</span>

<span class="c"># Browser options</span>
<span class="n">br</span><span class="o">.</span><span class="n">set_handle_equiv</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="n">br</span><span class="o">.</span><span class="n">set_handle_redirect</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="n">br</span><span class="o">.</span><span class="n">set_handle_referer</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="n">br</span><span class="o">.</span><span class="n">set_handle_robots</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

<span class="c"># Follows refresh 0 but not hangs on refresh &gt; 0</span>
<span class="n">br</span><span class="o">.</span><span class="n">set_handle_refresh</span><span class="p">(</span><span class="n">mechanize</span><span class="o">.</span><span class="n">_http</span><span class="o">.</span><span class="n">HTTPRefreshProcessor</span><span class="p">(),</span> <span class="n">max_time</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># Want debugging messages?</span>
<span class="c">#br.set_debug_http(True)</span>
<span class="c">#br.set_debug_redirects(True)</span>
<span class="c">#br.set_debug_responses(True)</span>

<span class="c"># User-Agent (this is cheating, ok?)</span>
<span class="n">br</span><span class="o">.</span><span class="n">addheaders</span> <span class="o">=</span> <span class="p">[(</span><span class="s">'User-agent'</span><span class="p">,</span> <span class="s">'Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.1) Gecko/2008071615 Fedora/3.0.1-1.fc9 Firefox/3.0.1'</span><span class="p">)]</span>

<span class="c"># Open some site, let's pick a random one, the first that pops in mind:</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'https://www.cityofmadison.com/epayment/parkingTicket/search.cfm'</span><span class="p">)</span>

<span class="n">html</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c"># Show the source</span>
<span class="c">#print html</span></code></pre></figure>

<p>This returns us the html of the city’s parking ticket page as a big string of HTML.</p>

<p><img src="/images/msnticket/1.png" /></p>

<h2 id="searching-for-tickets">Searching for Tickets</h2>

<p>In order to search for a parking ticket, it looks like I need to first accept the terms and continue.</p>

<p>Since Mechanize is ‘stateful’ - it acts like a browser tab that a user would have open - I can submit this form and continue working with my browser class.</p>

<p>Before we do that, here are some other things you can do with Mechanize:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Show the source</span>
<span class="c">#print html</span>
<span class="c"># or</span>

<span class="k">print</span> <span class="n">br</span><span class="o">.</span><span class="n">response</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c"># Show the html title</span>
<span class="k">print</span> <span class="n">br</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

<span class="c"># Show the response headers</span>
<span class="k">print</span> <span class="n">r</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="c"># or</span>
<span class="k">print</span> <span class="n">br</span><span class="o">.</span><span class="n">response</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>

<span class="c">#Show the available forms</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">br</span><span class="o">.</span><span class="n">forms</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">f</span>
    <span class="k">print</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span></code></pre></figure>

<p>Back to the main objective. We need to first:</p>

<ul>
  <li>Find the form on the page with the checkbox</li>
  <li>Select the checkbox</li>
  <li>Submit the form to continue</li>
</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#fet First hurdle: Accepting the terms. Here we find a form, click a checkbox, and submit the form to load the next page into mechanize</span>
<span class="n">br</span><span class="o">.</span><span class="n">select_form</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'termsAcceptance'</span><span class="p">)</span>
<span class="n">br</span><span class="o">.</span><span class="n">find_control</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"acceptTerms"</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="s">"1"</span><span class="p">]</span>
<span class="n">br</span><span class="o">.</span><span class="n">submit</span><span class="p">()</span></code></pre></figure>

<p>In order to do this, I needed to find the name of the form and the checkbox control. I used Chrome Developer tools to inspect it:</p>

<p><img src="/images/msnticket/2.png" /></p>

<p><img src="/images/msnticket/3.png" /></p>

<p>So we follow that action in our simulated browser and are brought to the Search page:
<img src="/images/msnticket/4.png" /></p>

<p>Great news! This is where we can enter our first dynamic input - a license plate to test. I do a similar inspection and find the names of the form and controls I need to manipulate:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">br</span><span class="o">.</span><span class="n">select_form</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'plateSearch'</span><span class="p">)</span>
<span class="n">br</span><span class="o">.</span><span class="n">find_control</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Plate"</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s">'123ABC'</span>
<span class="n">br</span><span class="o">.</span><span class="n">find_control</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"State"</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="s">"WI"</span><span class="p">]</span>
<span class="n">br</span><span class="o">.</span><span class="n">find_control</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"VehTyp"</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="s">"PC"</span><span class="p">]</span>
<span class="n">br</span><span class="o">.</span><span class="n">submit</span><span class="p">()</span>
<span class="n">text</span> <span class="o">=</span>  <span class="n">br</span><span class="o">.</span><span class="n">response</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c">#fet For inspection, we can write the text of the page that loads to a file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'msnticketresponse.html'</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></figure>

<p>Here’s what the HTML of the search returns for a plate with existing tickets:</p>

<p><img src="/images/msnticket/5.png" /></p>

<h3 id="manipulating-the-html-search-results-to-work-with-them-in-python">Manipulating the HTML Search Results to Work With Them in Python</h3>
<p>We need to take the HTML output and parse the page. The problem is that the output is not always regular. We need something like regular expressions that will let us recognize certain, sometimes repeated parts of the page.</p>

<p>The <a href="http://lxml.de/">LXML</a> library is a good starting place to process XML and HTML in Python.</p>

<p>We’ll also take advantage of <a href="http://www.w3schools.com/xpath/">XPATH, which is like regex for XML</a>:
Let’s inspect the HTML of the search results to find what is regular about these ticket results.
I’ve skipped over the header of the page and gone right to the meat of where the tickets are:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;table</span> <span class="na">id=</span><span class="s">"main"</span> <span class="na">cellspacing=</span><span class="s">"0"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;tr&gt;</span>
		<span class="nt">&lt;td</span> <span class="na">colspan=</span><span class="s">"2"</span><span class="nt">&gt;&lt;img</span> <span class="na">src=</span><span class="s">"/images/ePayment.jpg"</span> <span class="na">width=</span><span class="s">"740"</span> <span class="na">height=</span><span class="s">"106"</span><span class="nt">&gt;&lt;/td&gt;</span>
	<span class="nt">&lt;/tr&gt;</span>
	<span class="nt">&lt;tr&gt;</span>
		<span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">"sidebar"</span><span class="nt">&gt;</span>
			<span class="c">&lt;!-- InstanceBeginEditable name="Sidebar" --&gt;</span>
			
			<span class="c">&lt;!-- InstanceEndEditable --&gt;</span>
		<span class="nt">&lt;/td&gt;</span>
		<span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">"content"</span><span class="nt">&gt;</span>
			<span class="c">&lt;!-- InstanceBeginEditable name="Content" --&gt;</span>
			<span class="nt">&lt;h1</span> <span class="na">style=</span><span class="s">"float:left;"</span><span class="nt">&gt;</span>Parking Ticket Information<span class="nt">&lt;/h1&gt;</span>
			<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"float:right;margin-bottom:10px;"</span><span class="nt">&gt;&lt;a</span> <span class="na">class=</span><span class="s">"linkButton"</span> <span class="na">href=</span><span class="s">"index.cfm"</span> <span class="na">style=</span><span class="s">"width:200px;"</span><span class="nt">&gt;</span>Parking Ticket Payment Home<span class="nt">&lt;/a&gt;</span> <span class="ni">&amp;nbsp;&amp;nbsp;</span><span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"linkButton"</span> <span class="na">href=</span><span class="s">"search.cfm"</span> <span class="na">style=</span><span class="s">"width:100px;"</span><span class="nt">&gt;</span>New Search<span class="nt">&lt;/a&gt;&lt;/div&gt;</span>
			<span class="nt">&lt;br</span> <span class="na">clear=</span><span class="s">"all"</span> <span class="nt">/&gt;</span>
			
			
			<span class="nt">&lt;form</span> <span class="na">name=</span><span class="s">"Payments"</span> <span class="na">id=</span><span class="s">"Payments"</span> <span class="na">action=</span><span class="s">"ticketPayments.cfm"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">onsubmit=</span><span class="s">"return _CF_checkPayments(this)"</span><span class="nt">&gt;</span>
					<span class="nt">&lt;table</span> <span class="na">cellpadding=</span><span class="s">"0"</span> <span class="na">cellspacing=</span><span class="s">"0"</span> <span class="na">border=</span><span class="s">"0"</span> <span class="na">width=</span><span class="s">"100%"</span> <span class="na">style=</span><span class="s">"border: 1px solid #CCCCCC;"</span><span class="nt">&gt;</span>
						<span class="nt">&lt;tr&gt;</span>
								<span class="nt">&lt;td</span> <span class="na">colspan=</span><span class="s">"7"</span> <span class="na">class=</span><span class="s">"RequiredLabel"</span><span class="nt">&gt;&lt;br&gt;</span>(* indicates required field)<span class="nt">&lt;br&gt;&lt;br&gt;&lt;/td&gt;</span>
							<span class="nt">&lt;/tr&gt;</span>
						<span class="nt">&lt;tr</span> <span class="na">class=</span><span class="s">"backgroundMedium"</span><span class="nt">&gt;</span>
							
							<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"12%"</span><span class="nt">&gt;</span>Ticket No<span class="nt">&lt;/td&gt;</span>
							<span class="nt">&lt;TD</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"12%"</span><span class="nt">&gt;</span>Date of Violation<span class="nt">&lt;/TD&gt;</span> 
							<span class="nt">&lt;TD</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"12%"</span><span class="nt">&gt;</span>Plate No<span class="nt">&lt;/TD&gt;</span>
							<span class="nt">&lt;TD</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"10%"</span><span class="nt">&gt;</span>State<span class="nt">&lt;/TD&gt;</span>
							<span class="nt">&lt;TD</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"19%"</span><span class="nt">&gt;</span>Vehicle<span class="nt">&lt;/TD&gt;</span>
							<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"10%"</span><span class="nt">&gt;</span>Amount Due<span class="nt">&lt;/td&gt;</span>
							<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"25%"</span><span class="nt">&gt;</span>Payment Amount<span class="nt">&lt;/td&gt;</span>
						<span class="nt">&lt;/tr&gt;</span>
						
						
						
							<span class="nt">&lt;tr</span> <span class="nt">&gt;</span>
								
								<span class="nt">&lt;td&gt;</span> S123456 <span class="nt">&lt;/td&gt;</span>
								<span class="nt">&lt;td&gt;</span>09/27/2013 <span class="nt">&lt;/td&gt;</span>
								<span class="nt">&lt;td&gt;</span>123ABC   <span class="nt">&lt;/td&gt;</span>
								<span class="nt">&lt;td&gt;</span>Wisconsin <span class="nt">&lt;/td&gt;</span>
								<span class="nt">&lt;td&gt;</span>Standard Passenger Car Plate <span class="nt">&lt;/td&gt;</span>
								<span class="nt">&lt;td&gt;</span>
									$55.00  
								<span class="nt">&lt;/td&gt;</span>
								
								
									<span class="nt">&lt;td&gt;</span>
										<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"radio"</span> <span class="na">name=</span><span class="s">"p_S123456"</span> <span class="na">value=</span><span class="s">"BalanceDue"</span> <span class="nt">&gt;</span>Balance Due ($55.00)<span class="nt">&lt;br&gt;</span>
											<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"radio"</span> <span class="na">name=</span><span class="s">"p_S123456"</span> <span class="na">value=</span><span class="s">"Other"</span> <span class="nt">&gt;</span>Other $<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"pOther_S123456"</span> <span class="na">id=</span><span class="s">"pOther_S123456"</span>  <span class="na">type=</span><span class="s">"text"</span> <span class="na">maxlength=</span><span class="s">"14"</span>  <span class="na">size=</span><span class="s">"10"</span>  <span class="nt">/&gt;</span>
									<span class="nt">&lt;/td&gt;</span>
								
							<span class="nt">&lt;/tr&gt;</span>
							
							<span class="nt">&lt;tr</span>  <span class="na">class=</span><span class="s">"backgroundLight"</span><span class="nt">&gt;</span>
								
								<span class="nt">&lt;td&gt;</span> S123457 <span class="nt">&lt;/td&gt;</span>
								<span class="nt">&lt;td&gt;</span>12/08/2013 <span class="nt">&lt;/td&gt;</span>
								<span class="nt">&lt;td&gt;</span>123ABC   <span class="nt">&lt;/td&gt;</span>
								<span class="nt">&lt;td&gt;</span>Wisconsin <span class="nt">&lt;/td&gt;</span>
								<span class="nt">&lt;td&gt;</span>Standard Passenger Car Plate <span class="nt">&lt;/td&gt;</span>
								<span class="nt">&lt;td&gt;</span>
									$20.00  
								<span class="nt">&lt;/td&gt;</span>
								
								
									<span class="nt">&lt;td&gt;</span>
										<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"radio"</span> <span class="na">name=</span><span class="s">"p_S123457"</span> <span class="na">value=</span><span class="s">"BalanceDue"</span> <span class="nt">&gt;</span>Balance Due ($20.00)<span class="nt">&lt;br&gt;</span>
											<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"radio"</span> <span class="na">name=</span><span class="s">"p_S123457"</span> <span class="na">value=</span><span class="s">"Other"</span> <span class="nt">&gt;</span>Other $<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"pOther_S123457"</span> <span class="na">id=</span><span class="s">"pOther_S123457"</span>  <span class="na">type=</span><span class="s">"text"</span> <span class="na">maxlength=</span><span class="s">"14"</span>  <span class="na">size=</span><span class="s">"10"</span>  <span class="nt">/&gt;</span>
									<span class="nt">&lt;/td&gt;</span>
								
							<span class="nt">&lt;/tr&gt;</span>
																

						
						<span class="nt">&lt;tr&gt;</span>
							<span class="nt">&lt;td</span> <span class="na">colspan=</span><span class="s">"2"</span><span class="nt">&gt;</span>Email Address: <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"RequiredLabel"</span><span class="nt">&gt;</span>*<span class="nt">&lt;/span&gt;</span>	<span class="nt">&lt;/td&gt;</span>
							<span class="nt">&lt;td</span> <span class="na">colspan=</span><span class="s">"5"</span><span class="nt">&gt;</span>
								<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"email"</span> <span class="na">size=</span><span class="s">"35"</span> <span class="na">maxlength=</span><span class="s">"50"</span> <span class="na">value=</span><span class="s">""</span><span class="nt">&gt;</span>
							<span class="nt">&lt;/td&gt;</span>
						<span class="nt">&lt;/tr&gt;</span>
					<span class="nt">&lt;/table&gt;</span>
					<span class="nt">&lt;div</span> <span class="na">align=</span><span class="s">"center"</span> <span class="na">style=</span><span class="s">"margin-top: 8px;"</span><span class="nt">&gt;&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">name=</span><span class="s">"ticketPayments"</span> <span class="na">value=</span><span class="s">"Continue"</span><span class="nt">&gt;&lt;/div&gt;</span>
				<span class="nt">&lt;/form&gt;</span>

				<span class="c">&lt;!-- InstanceEndEditable --&gt;</span>
			
		<span class="nt">&lt;/td&gt;</span>
	<span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span></code></pre></figure>

<p>We see that each discrete piece of data about each ticket is contained in a table cell <code class="highlighter-rouge">&lt;td&gt;</code>, and that each of these is the child of a <code class="highlighter-rouge">&lt;tr&gt;</code> that stands for each ticket. To get each ticket, we’ll figure out what is common to those <code class="highlighter-rouge">&lt;tr&gt;</code>s.</p>

<p>Each is the direct child of a form. Since there’s only one form on the page, we can start there. Note that XPATH requires some strict syntax and won’t necessarily follow the design of your element nesting here.</p>

<p>Here’s the XPATH syntax that finally worked to return each ticket and nothing else:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">tickets</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//form/table/tr[position()&gt;2]//td//text()'</span><span class="p">)</span></code></pre></figure>

<p>Here’s how we read this, from right to left:</p>

<ul>
  <li>//text()
    <ul>
      <li>Two slashes: <em>Select ALL of</em></li>
      <li>text() - Select the text inside this element (as opposed to the class, or the href, or another attribute)</li>
    </ul>
  </li>
  <li>//td - Select ALL &lt;td&gt; elements (even if they’re not the direct child)</li>
  <li>/tr[position()&gt;2] - <a href="http://www.w3schools.com/xpath/xpath_syntax.asp">This is the complicated one</a>. Select <code class="highlighter-rouge">&lt;tr&gt;</code>s that are the direct children of the parent (one slash). Only select <code class="highlighter-rouge">&lt;tr&gt;</code>s that are the 3rd or greater <code class="highlighter-rouge">&lt;tr&gt;</code> child of their parent. This is to accommodate for these two <code class="highlighter-rouge">&lt;tr&gt;</code>s in our page that come before the tickets:</li>
</ul>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;tr&gt;</span>
		<span class="nt">&lt;td</span> <span class="na">colspan=</span><span class="s">"7"</span> <span class="na">class=</span><span class="s">"RequiredLabel"</span><span class="nt">&gt;&lt;br&gt;</span>(* indicates required field)<span class="nt">&lt;br&gt;&lt;br&gt;&lt;/td&gt;</span>
	<span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;tr</span> <span class="na">class=</span><span class="s">"backgroundMedium"</span><span class="nt">&gt;</span>
	
	<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"12%"</span><span class="nt">&gt;</span>Ticket No<span class="nt">&lt;/td&gt;</span>
	<span class="nt">&lt;TD</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"12%"</span><span class="nt">&gt;</span>Date of Violation<span class="nt">&lt;/TD&gt;</span> 
	<span class="nt">&lt;TD</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"12%"</span><span class="nt">&gt;</span>Plate No<span class="nt">&lt;/TD&gt;</span>
	<span class="nt">&lt;TD</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"10%"</span><span class="nt">&gt;</span>State<span class="nt">&lt;/TD&gt;</span>
	<span class="nt">&lt;TD</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"19%"</span><span class="nt">&gt;</span>Vehicle<span class="nt">&lt;/TD&gt;</span>
	<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"10%"</span><span class="nt">&gt;</span>Amount Due<span class="nt">&lt;/td&gt;</span>
	<span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"Heading14Bold"</span> <span class="na">width=</span><span class="s">"25%"</span><span class="nt">&gt;</span>Payment Amount<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span></code></pre></figure>

<ul>
  <li>//form/table - Select tables that are the direct children of ALL forms on the page.</li>
</ul>

<p>Whew.</p>

<p>This give us (semi) nice lists like:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="p">[</span><span class="s">' S123456 '</span><span class="p">,</span> <span class="s">'09/27/2013 '</span><span class="p">,</span> <span class="s">'123ABC   '</span><span class="p">,</span> <span class="s">'Wisconsin '</span><span class="p">,</span> <span class="s">'Standard Passenger Car</span><span class="err">
</span><span class="s"> Plate '</span><span class="p">,</span> <span class="s">'</span><span class="se">\r\n\t\t\t\t\t\t\t\t\t</span><span class="s">$65.00  </span><span class="se">\r\n\t\t\t\t\t\t\t\t</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\r\n\t\t\t\t\t\
</span><span class="s">t</span><span class="se">\t\t\t\t</span><span class="s">'</span><span class="p">,</span> <span class="s">'Balance Due ($65.00)'</span><span class="p">,</span> <span class="s">'Other $'</span><span class="p">,</span> <span class="s">' S123457 '</span><span class="p">,</span> <span class="s">'12/08/2013 '</span><span class="p">,</span> <span class="s">'123</span><span class="err">
</span><span class="s">ABC   '</span><span class="p">,</span> <span class="s">'Wisconsin '</span><span class="p">,</span> <span class="s">'Standard Passenger Car Plate '</span><span class="p">,</span> <span class="s">'</span><span class="se">\r\n\t\t\t\t\t\t\t\t\t</span><span class="s">$</span><span class="err">
</span><span class="s">30.00  </span><span class="se">\r\n\t\t\t\t\t\t\t\t</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\r\n\t\t\t\t\t\t\t\t\t\t</span><span class="s">'</span><span class="p">,</span> <span class="s">'Balance Due ($30.00)'</span>
<span class="p">,</span> <span class="s">'Other $'</span><span class="p">,</span> <span class="s">'Email Address: '</span><span class="p">,</span> <span class="s">'*'</span><span class="p">,</span> <span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\r\n\t\t\t\t\t\t\t\t</span><span class="s">'</span><span class="p">]</span></code></pre></figure>

<p>There’s a lot of garbage in there, like carriage returns, tabs, and spaces. Additionally, we’re only interested in <em>some</em> of the list elements:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#Strip out extra spaces, newlines, tabs. </span>
<span class="c">#For each of these characters, replace itself with null in every element in tickets. </span>
<span class="c">#Redefine tickets as this new string-replaced list.</span>
<span class="n">chlist</span> <span class="o">=</span> <span class="p">[</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span><span class="s">'</span><span class="se">\r</span><span class="s">'</span><span class="p">,</span><span class="s">'</span><span class="err">\</span><span class="s">s'</span><span class="p">,</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chlist</span><span class="p">:</span>
	<span class="n">tickets</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="s">''</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tickets</span><span class="p">]</span>

<span class="c">#Build a dictionary, d. Parse the list of all tickets, organize them ordinally in a dictionary. </span>
<span class="c">#Each dictionary entry will be a list. Pop the first 9 values off of tickets and create a new dictionary entry. </span>
<span class="c">#Take the new tickets list and pop the next 9 values. Iterate until the list is too small to possibly contain a ticket (less than 4 elements long)</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">#Counter</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickets</span><span class="p">)</span><span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
	<span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tickets</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>
	<span class="n">tickets</span> <span class="o">=</span> <span class="n">tickets</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>
	<span class="c">#Increment the counter</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c">#Neatly printing our output:</span>
<span class="c">#Define our output template</span>

<span class="n">template</span> <span class="o">=</span> <span class="s">'''Ticket No: </span><span class="si">%</span><span class="s">s
Date of Violation: </span><span class="si">%</span><span class="s">s
Plate No: </span><span class="si">%</span><span class="s">s
State: </span><span class="si">%</span><span class="s">s
Vehicle: </span><span class="si">%</span><span class="s">s
Amount Due: </span><span class="si">%</span><span class="s">s'''</span>

<span class="c"># For each entry in the dictionary, replace the template with the real values and insert a new line.</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
	<span class="n">results</span> <span class="o">+=</span> <span class="n">template</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n\n</span><span class="s">'</span>
<span class="k">print</span> <span class="n">results</span></code></pre></figure>

<p>Apart from the neatly printed output, we also now have a dictionary of tickets. We’ve achieved the goal of a fake ‘API’ for searching for parking tickets.</p>

<p>Stay tuned for actually <em>paying</em> them.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2017/04/24/washerbot-and-dryerbot-part-5/">
            WasherBot and DryerBot, Part 5: A Measurement Algorithm and Text Message Integration
            <small>24 Apr 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/12/09/washerbot-and-dryerbot-part-4/">
            WasherBot and DryerBot, Part 4: A Low-Pass Filter and Reading From Laundry Appliances
            <small>09 Dec 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/12/03/washerbot-and-dryerbot-part-3/">
            WasherBot and DryerBot, Part 3: Connecting to the Pi and Building a Voltage Divider
            <small>03 Dec 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
