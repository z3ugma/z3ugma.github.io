<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

<!--Facebook share tags -->
  <meta property="og:url"                content="/" />
  <meta property="og:type"               content="article" />
  <meta property="og:title"              content="Home"/>
  <meta property="og:description"        content="" />
  <meta property="og:image"              content="" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Python Monty
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Ubuntu">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/f_favicon.png">
                                 <link rel="shortcut icon" href="/public/f_favicon.png">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0d">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
          <img src="https://avatars1.githubusercontent.com/u/6099983?v=3&s=460" height="200"/>
      <h1>
        <a href="/">
          Python Monty
        </a>
      </h1>
      <p class="lead">Explaining the terrible code I write as I go. Mostly in Python. Also some restaurant reviews and recipes.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item active" href="/">Home</a>

      

      
      
        
          
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive/">Archive</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    </nav>

    <p>&copy; 2018. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/04/24/washerbot-and-dryerbot-part-5/">
        WasherBot and DryerBot, Part 5: A Measurement Algorithm and Text Message Integration
      </a>
    </h1>

    <span class="post-date">24 Apr 2017</span>

    <h3 id="table-of-contents">Table of Contents</h3>

<ul>
  <li><a href="/2016/11/21/washerbot-and-dryerbot-part-1/">Part 1: How to Tell If an Appliance Is Running</a></li>
  <li><a href="/2016/11/22/washerbot-and-dryerbot-part-2/">Part 2: Current Sensors and Burden Resistors</a></li>
  <li><a href="/2016/12/03/washerbot-and-dryerbot-part-3/">Part 3: Connecting to the Pi and Building a Voltage Divider</a></li>
  <li><a href="/2016/12/09/washerbot-and-dryerbot-part-4/">Part 4: A Low-Pass Filter and Reading From Laundry Appliances</a></li>
  <li><a href="/2017/04/24/washerbot-and-dryerbot-part-5/">Part 5: A Measurement Algorithm and Text Message Integration</a></li>
</ul>

<p>As we saw in Part 4, the ‚Äúthicker‚Äù the AC wave appears on a graph of our MCP3002 measurements, the more power it‚Äôs consuming. This ‚Äúthickness‚Äù is a great proxy for power consumption called the ‚Äúamplitude‚Äù of the wave - the distance between the highest and lowest points of the wave.</p>

<p>When an appliance is using no power, the amplitude should be 0. In testing, I found that jittery power can sometimes produce a resting amplitude of up to +/-6, so our actual resting amplitude turns out to be 12.</p>

<p>In order to find the amplitude of the 60Hz wave, we need to measure it for at least 1/60th of a second. This will guarantee that we‚Äôve measured an entire cycle of the wave. If we run the MCP3002 at 50 kHz, then we‚Äôll need at least 50,000/60 = 834 measurements to measure a full cycle.</p>

<p>This will only let us measure a 1/60th of a second time period, though. Maybe the appliance isn‚Äôt using much power during that tiny window. If we increase the amount of time we‚Äôre measuring for, we can get a better assessment of power usage.</p>

<p>Let‚Äôs arbitrarily pick 7500 measurements. That‚Äôs just about 9 cycles, or 3/20ths of a second.</p>

<p>We can see that measuring for just 3/20ths of a second will accumulate a lot of data. If we want to do meaningful work with this long list of numbers, we need to simplify it down to a single representation of <em>state</em>.</p>

<p>State is a concept from computer science. When we say something has a state, we are describing the properties of that object at a particular point in time. Like on October 27th, a pumpkin might have a state of ‚Äòpicked‚Äô. Then, on October 30th, it goes from ‚Äòpicked‚Äô to ‚Äòcarved‚Äô and on Halloween it goes to ‚Äòjack-o-lantern‚Äô. By November 3rd, it‚Äôs ‚Äòrotten‚Äô.</p>

<p>Our pumpkin has many states, but our appliances really only have two for our purposes - ‚Äòon‚Äô and ‚Äòoff.‚Äô</p>

<h3 id="simplyifing-the-measurement">Simplyifing the Measurement</h3>

<p>To make a shorter list of numbers, we can take out unnecessary information from our sine wave. The ‚Äòunnecessary‚Äô information is basically ‚Äòanything that isn‚Äôt a peak or a trough‚Äô since those are the only points we care about to calculate amplitude.</p>

<p>We <em>could</em> just take the highest and lowest points of the entire 7500 item list and call it a day, but this might be a problem when there are outliers or measurement errors that are sudden spikes in the data. So we want to amplify the effect of peaks and troughs, but smooth out the effect of any one outlier peak or trough.</p>

<p>Make a sliding ‚Äòwindow‚Äô and every 100 measurements, find the max and min value of the 50 preceding and 50 next measurements.
Taking the average of these ‚Äòwindowed‚Äô amplitudes means that any one accidental spike will only count toward the average of its own peak or trough, and the rest of the wave cycles will push the average closer to its true value.</p>

<p>Notice how, in this image, a single spike makes the global maximum around 625 while the true maximum, seen over several cycles, is closer to 595. Using the ‚Äòwindow‚Äô approach pulls the average maximum closer to its true value.</p>

<p><img src="/images/washerdryerbot/window_measurements.png" alt="" width="600px" /></p>

<p>To get from an average peak / trough to an average amplitude is as easy as subracting the trough from the peak.</p>

<p>Finally, we come to our measurement algorithm: a function that starts off by measuring each channel 7500 times at 50 kHz and spits out a single number - an adjusted-average amplitude.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">measure</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>    
    <span class="n">ch0list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ch0avg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">number</span><span class="p">):</span> <span class="c">#Measure n times</span>

        <span class="n">ch0list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_mcp3002</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,(</span><span class="n">number</span><span class="o">-</span><span class="mi">50</span><span class="p">),</span><span class="mi">100</span><span class="p">):</span> <span class="c"># Make peak/trough windows</span>

        <span class="n">ch0max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ch0list</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">50</span><span class="p">:</span><span class="n">step</span><span class="o">+</span><span class="mi">50</span><span class="p">])</span>
        <span class="n">ch0min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ch0list</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">50</span><span class="p">:</span><span class="n">step</span><span class="o">+</span><span class="mi">50</span><span class="p">])</span>

        <span class="n">ch0avg</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ch0max</span> <span class="o">-</span> <span class="n">ch0min</span><span class="p">))</span>

    <span class="n">ch0</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">ch0avg</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch0avg</span><span class="p">)</span> <span class="c">#Calculate the average amplitude</span>

    <span class="k">return</span> <span class="n">ch0</span>

<span class="k">print</span> <span class="n">measure</span><span class="p">(</span><span class="mi">7500</span><span class="p">)</span></code></pre></figure>

<p>Let‚Äôs have a look at some real-life amplitude measurements during a washer and dryer cycle:</p>

<p><img src="/images/washerdryerbot/readings_grafana.png" alt="" width="600px" /></p>

<p>At rest, each appliance usually has an average-adjusted amplitude of 6.</p>

<h3 id="from-amplitude-to-state-and-keeping-track-of-state">From Amplitude to State, and Keeping Track of State</h3>

<p>So then, to get from amplitude to appliance state is not a taxing calculation: Any amplitude greater than 12 is ‚Äòon‚Äô, anything 12 or less is ‚Äòoff‚Äô</p>

<p>We set up our measurement script to run once every minute and find the current state of the appliance. But the script only knows what the appliance is doing this very minute. How can we find out what it did in the previous minute?</p>

<p>For that, we‚Äôll need a database. <a href="https://github.com/influxdata/influxdb">InfluxDB</a> is a great choice for this application, as it‚Äôs designed for measuring things over time.</p>

<p>So to add to our script that runs each minute, we‚Äôll write the measurement and state to the database:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>
<span class="kn">from</span> <span class="nn">influxdb</span> <span class="kn">import</span> <span class="n">InfluxDBClient</span>

<span class="n">USER</span> <span class="o">=</span> <span class="s">'root'</span>
<span class="n">PASSWORD</span> <span class="o">=</span> <span class="s">'root'</span>
<span class="n">DBNAME</span> <span class="o">=</span> <span class="s">'db'</span>
<span class="n">HOST</span> <span class="o">=</span> <span class="s">'hostname'</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8086</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">InfluxDBClient</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">,</span> <span class="n">USER</span><span class="p">,</span> <span class="n">PASSWORD</span><span class="p">,</span> <span class="n">DBNAME</span><span class="p">)</span>

<span class="n">client</span><span class="o">.</span><span class="n">create_database</span><span class="p">(</span><span class="n">DBNAME</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">switch_database</span><span class="p">(</span><span class="n">DBNAME</span><span class="p">)</span>

<span class="n">mm</span> <span class="o">=</span> <span class="n">measure</span><span class="p">(</span><span class="mi">7500</span><span class="p">)</span> <span class="c"># As defined above</span>

<span class="n">statemin</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">state</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">mm</span><span class="o">&gt;</span><span class="n">statemin</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

<span class="n">newpoint</span> <span class="o">=</span> <span class="p">[{</span>
    <span class="s">"measurement"</span><span class="p">:</span> <span class="s">"voltage"</span><span class="p">,</span>
    <span class="s">"fields"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"washer"</span><span class="p">:</span> <span class="n">mm</span>
    <span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span>
    <span class="s">"measurement"</span><span class="p">:</span> <span class="s">"state"</span><span class="p">,</span>
    <span class="s">"fields"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"washer"</span><span class="p">:</span> <span class="n">state</span>
    <span class="p">}</span>
<span class="p">}]</span>
<span class="n">client</span><span class="o">.</span><span class="n">write_points</span><span class="p">(</span><span class="n">newpoint</span><span class="p">)</span> </code></pre></figure>

<p>We can now keep track directly of when an appliance is on or off:
<img src="/images/washerdryerbot/state_grafana.png" alt="" width="600px" /></p>

<h3 id="comparing-states-and-taking-actions">Comparing States and Taking Actions</h3>

<p>Now we can compare the current state to the previous state.</p>

<p>Most of the time, we‚Äôll find that the state is unchanged. An appliance in motion tends to remain in motion, and an appliance at rest tends to remain at rest. But occasionally, we‚Äôll find that the state is different - the appliance started up or the appliance powered down.</p>

<p>So we have to get the last known state:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>
<span class="n">query</span> <span class="o">=</span> <span class="s">"SELECT * from state GROUP BY * ORDER BY DESC LIMIT 1"</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">resultlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get_points</span><span class="p">())</span>
<span class="n">lastknownstate</span> <span class="o">=</span> <span class="n">resultlist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">'washer'</span><span class="p">]</span></code></pre></figure>

<p>Now we compare the last known state to the current state:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>
<span class="n">different</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">statemin</span><span class="o">=</span><span class="mi">12</span>
<span class="n">currentstate</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">measurement</span><span class="o">&gt;</span><span class="n">statemin</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">if</span> <span class="n">currentstate</span> <span class="o">!=</span> <span class="n">lastknownstate</span><span class="p">:</span>
    <span class="n">different</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c">#Do stuff</span></code></pre></figure>

<p>There are two possible state transitions: ‚Äòon‚Äô to ‚Äòoff‚Äô and ‚Äòoff‚Äô to ‚Äòon‚Äô. We‚Äôve called these ‚Äòpowering up‚Äô or ‚Äòshutting down‚Äô. I only want to get text messages when an appliance shuts down - after all, when it turns on someone is standing there pushing the ‚Äòon‚Äô button.</p>

<p>To get text messages from our Python script we‚Äôll use the awesome <a href="https://www.twilio.com/docs/quickstart/python/sms/sending-via-rest">Twilio Python REST API</a>.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">twilio.rest</span> <span class="kn">import</span> <span class="n">TwilioRestClient</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="n">account_sid</span> <span class="o">=</span> <span class="s">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span> <span class="c"># Your Account SID from www.twilio.com/console</span>
<span class="n">auth_token</span>  <span class="o">=</span> <span class="s">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>  <span class="c"># Your Auth Token from www.twilio.com/console</span>
<span class="n">twilioclient</span> <span class="o">=</span> <span class="n">TwilioRestClient</span><span class="p">(</span><span class="n">account_sid</span><span class="p">,</span> <span class="n">auth_token</span><span class="p">)</span>

<span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="s">"+15555555555"</span><span class="p">,</span> <span class="s">"+15555554444"</span><span class="p">]</span> <span class="c"># Your intended SMS recipients</span>

<span class="n">currenttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s">'US/Central'</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'</span><span class="si">%-</span><span class="s">I:</span><span class="si">%</span><span class="s">m </span><span class="si">%</span><span class="s">p'</span><span class="p">)</span> <span class="c"># The time like '6:10 PM'</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="p">(</span><span class="n">currentstate</span> <span class="o">!=</span> <span class="n">lastknownstate</span><span class="p">)</span> <span class="ow">and</span> <span class="n">currentstate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c">#Only do this when the appliance turns off</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">:</span>
                <span class="n">twilioclient</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="p">(</span><span class="s">"üíß Washer is done! "</span> <span class="o">+</span> <span class="n">currenttime</span><span class="p">),</span>
                    <span class="n">to</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                    <span class="n">from_</span><span class="o">=</span><span class="s">"+15555553333"</span><span class="p">)</span> <span class="c"># Replace with your Twilio number</span></code></pre></figure>

<p>Now I‚Äôm happily enjoying my laziness and a prompt turnaround on laundry:</p>

<p><img src="/images/washerdryerbot/final_text_iphone5s_spacegrey_portrait.png" alt="" width="350px" /></p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/12/09/washerbot-and-dryerbot-part-4/">
        WasherBot and DryerBot, Part 4: A Low-Pass Filter and Reading From Laundry Appliances
      </a>
    </h1>

    <span class="post-date">09 Dec 2016</span>

    <h3 id="table-of-contents">Table of Contents</h3>

<ul>
  <li><a href="/2016/11/21/washerbot-and-dryerbot-part-1/">Part 1: How to Tell If an Appliance Is Running</a></li>
  <li><a href="/2016/11/22/washerbot-and-dryerbot-part-2/">Part 2: Current Sensors and Burden Resistors</a></li>
  <li><a href="/2016/12/03/washerbot-and-dryerbot-part-3/">Part 3: Connecting to the Pi and Building a Voltage Divider</a></li>
  <li><a href="/2016/12/09/washerbot-and-dryerbot-part-4/">Part 4: A Low-Pass Filter and Reading From Laundry Appliances</a></li>
  <li><a href="/2017/04/24/washerbot-and-dryerbot-part-5/">Part 5: A Measurement Algorithm and Text Message Integration</a></li>
</ul>

<p>When I was following the <a href="https://openenergymonitor.org/emon/buildingblocks/ct-sensors-interface">OpenEnergyMon guide</a> I noticed they were including a capacitor in their circuit:</p>

<p><img src="/images/washerdryerbot/wth_capacitor.png" alt="" /></p>

<p>What‚Äôs that there for? It‚Äôs to provide an alternative path for some of the current to flow to the ground. Capacitors take some time to charge up and then discharge all at once, in a way that is dependent on the frequency of the current flowing through them. An arrangement like this with a resistor and a capacitor together is called a <strong><a href="http://www.electronics-tutorials.ws/filter/filter_2.html">low-pass filter</a></strong>, meaning that only signals with a low frequency will be able to pass. It will filter out excess noise.</p>

<p><a href="http://openenergymonitor.blogspot.fr/2010/03/reducing-noise-adding-capacitor.html">This is another great discussion on the subject</a>.</p>

<p>Let‚Äôs hook up a 10uF capacitor to our circuit:</p>

<p><img src="/images/washerdryerbot/mcp3002_lowpass.png" alt="" /></p>

<p>I did some experimenting by measuring the voltage signal with and without the low-pass filter.</p>

<p>Across the entire range of the ADC:
<img src="/images/washerdryerbot/lowpass_output.png" alt="" /></p>

<p>and zoomed in:
<img src="/images/washerdryerbot/lowpass_output_zoomed.png" alt="" /></p>

<p>As you can see, it‚Äôs not trivial. A perfectly clean signal would measure 511 every time, but there‚Äôs some jitter. With the low-pass filter, the difference between the maximum value and the minimum is around 15. Without the filter, it‚Äôs much as 50. To a crude approximation, the filter adds around 10% accuracy to our measurement.</p>

<h3 id="two-jacks-and-two-channels">Two Jacks and Two Channels</h3>

<p>Up to this point, we‚Äôve only been measuring one input at a time. With 2 channels, the MCP3002 can read 2 voltages. And with 2 laundry appliances, that‚Äôs what I need to do.</p>

<p>We‚Äôll add a second jack to the circuit:</p>

<p><img src="/images/washerdryerbot/mcp3002_2jack.png" alt="" /></p>

<p>We can share the same voltage divider, and direct our output to channel 1.</p>

<h3 id="measuring-the-real-appliances">Measuring the Real Appliances</h3>

<p>Now, in order to translate voltage readings into the state of the appliance, I need to actually measure the appliances. I turned the breaker off to the dryer, unplugged it, and took off the back cover to fit the current sensor around 1 of the wires. A 220V dryer in the US has 4 wires coming into it. The green ground, 2 phases of power (red and black) and a white neutral. After some trial and error, I found that my dryer had the heating element powered by the left phase and the motor powered by the right phase.</p>

<p><img src="/images/washerdryerbot/dryer_wire.jpeg" alt="" /></p>

<p>For the washer, I turned off the breaker to the outlet it was plugged into and put the current sensor around the power line inside the outlet.</p>

<p>I cued up the measurement script and took some readings of the dryer:</p>

<p><img src="/images/washerdryerbot/washeroff_dryeron.png" alt="" /></p>

<p>It was basically perfect. I was excited here - the washer reading stays almost exactly at baseline and the dryer reading starts out there. When the dryer turns on, it is instantaneously recognizable in the graph.</p>

<p>In Part 5, I‚Äôll show you my algorithm for turning thousands of measurements into a single meaningful data point.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/12/03/washerbot-and-dryerbot-part-3/">
        WasherBot and DryerBot, Part 3: Connecting to the Pi and Building a Voltage Divider
      </a>
    </h1>

    <span class="post-date">03 Dec 2016</span>

    <h3 id="table-of-contents">Table of Contents</h3>

<ul>
  <li><a href="/2016/11/21/washerbot-and-dryerbot-part-1/">Part 1: How to Tell If an Appliance Is Running</a></li>
  <li><a href="/2016/11/22/washerbot-and-dryerbot-part-2/">Part 2: Current Sensors and Burden Resistors</a></li>
  <li><a href="/2016/12/03/washerbot-and-dryerbot-part-3/">Part 3: Connecting to the Pi and Building a Voltage Divider</a></li>
  <li><a href="/2016/12/09/washerbot-and-dryerbot-part-4/">Part 4: A Low-Pass Filter and Reading From Laundry Appliances</a></li>
  <li><a href="/2017/04/24/washerbot-and-dryerbot-part-5/">Part 5: A Measurement Algorithm and Text Message Integration</a></li>
</ul>

<p>Time to get started with the Pi.</p>

<p>First, we need to hook the ADC up to the Pi. There are several good tutorials on this but <a href="http://raspberry.io/projects/view/reading-from-a-mcp3002-analog-to-digital-converter/">I found this one to be the most helpful</a>.</p>

<p>We‚Äôre using the <a href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/spi/README.md">SPI interface</a>, so we want to hook up the Pi to the MCP3002 like so (note the little divot on the left side of the MCP3002 for alignment):</p>

<table>
  <thead>
    <tr>
      <th><strong>MCP3002</strong></th>
      <th><strong>RPi</strong></th>
      <th><strong>Reason</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>VDD</td>
      <td>3V3 +</td>
      <td>Operating voltage; max voltage</td>
    </tr>
    <tr>
      <td>CLK</td>
      <td>SCLK</td>
      <td>Clock sync</td>
    </tr>
    <tr>
      <td>DOUT</td>
      <td>MISO</td>
      <td>Data out of the MCP3002 and into the Pi (Master In; Slave Out)</td>
    </tr>
    <tr>
      <td>DIN</td>
      <td>MOSI</td>
      <td>Data into the MCP3002 and out of the Pi (Master Out;Slave In)</td>
    </tr>
    <tr>
      <td>CS</td>
      <td>CE0</td>
      <td>Chip Select - there are 2 data channels on the Pi and we‚Äôll use the first one, 0</td>
    </tr>
    <tr>
      <td>VSS</td>
      <td>GND (3V3 - )</td>
      <td>Ground (On the CanaKit breakout, it‚Äôs also called ‚Äú3V3 -‚Äú</td>
    </tr>
  </tbody>
</table>

<p><img src="/images/washerdryerbot/mcp3002_initial.png" alt="" /></p>

<p>This leaves 2 pins unconnected on the MCP3002 - CH0 and CH1 - the 2 channels of data we can measure. Let‚Äôs leave them empty for now.</p>

<h3 id="programming-the-pi">Programming the Pi</h3>

<p>Now we can finally measure using the Pi. Boot into your Pi and get it into SPI mode:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>apt-get <span class="nb">install </span>python-dev python-pip
<span class="nb">sudo </span>modprobe spi_bcm2708
<span class="nb">sudo </span>pip <span class="nb">install </span>spidev</code></pre></figure>

<p>And download my <a href="/files/measure.py">generic measuring script</a></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>
<span class="c">#-------------------------------------------------------------------------------</span>
<span class="c"># Name:        MCP3002 Measure 3V3</span>
<span class="c"># Purpose:     Measure the 3V3 Supply of the Raspberry Pi</span>
<span class="c">#-------------------------------------------------------------------------------</span>

<span class="kn">import</span> <span class="nn">spidev</span> <span class="c"># import the SPI driver</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">vref</span> <span class="o">=</span> <span class="mf">3.3</span> <span class="o">*</span> <span class="mi">1000</span> <span class="c"># V-Ref in mV (Vref = VDD for the MCP3002)</span>
<span class="n">resolution</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">10</span> <span class="c"># for 10 bits of resolution</span>
<span class="n">calibration</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># 38 # in mV, to make up for the precision of the components</span>

<span class="c"># MCP3002 Control bits</span>
<span class="c">#</span>
<span class="c">#   7   6   5   4   3   2   1   0</span>
<span class="c">#   X   1   S   O   M   X   X   X</span>
<span class="c">#</span>
<span class="c"># bit 6 = Start Bit</span>
<span class="c"># S = SGL or \DIFF SGL = 1 = Single Channel, 0 = \DIFF is pseudo differential</span>
<span class="c"># O = ODD or \SIGN</span>
<span class="c"># in Single Ended Mode (SGL = 1)</span>
<span class="c">#   ODD 0 = CH0 = + GND = - (read CH0)</span>
<span class="c">#       1 = CH1 = + GND = - (read CH1)</span>
<span class="c"># in Pseudo Diff Mode (SGL = 0)</span>
<span class="c">#   ODD 0 = CH0 = IN+, CH1 = IN-</span>
<span class="c">#       1 = CH0 = IN-, CH1 = IN+</span>
<span class="c">#</span>
<span class="c"># M = MSBF</span>
<span class="c"># MSBF = 1 = LSB first format</span>
<span class="c">#        0 = MSB first format</span>
<span class="c"># ------------------------------------------------------------------------------</span>


<span class="c"># SPI setup</span>
<span class="n">spi_max_speed</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="c"># 1 MHz (1.2MHz = max for 2V7 ref/supply)</span>
<span class="c"># reason is that the ADC input cap needs time to get charged to the input level.</span>
<span class="n">CE</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># CE0 | CE1, selection of the SPI device</span>

<span class="n">spi</span> <span class="o">=</span> <span class="n">spidev</span><span class="o">.</span><span class="n">SpiDev</span><span class="p">()</span>
<span class="n">spi</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">CE</span><span class="p">)</span> <span class="c"># Open up the communication to the device</span>
<span class="n">spi</span><span class="o">.</span><span class="n">max_speed_hz</span> <span class="o">=</span> <span class="n">spi_max_speed</span>

<span class="c">#</span>
<span class="c"># create a function that sets the configuration parameters and gets the results</span>
<span class="c"># from the MCP3002</span>
<span class="c">#</span>
<span class="k">def</span> <span class="nf">read_mcp3002</span><span class="p">(</span><span class="n">channel</span><span class="p">):</span>
    <span class="c"># see datasheet for more information</span>
    <span class="c"># 8 bit control :</span>
    <span class="c"># X, Strt, SGL|!DIFF, ODD|!SIGN, MSBF, X, X, X</span>
    <span class="c"># 0, 1,    1=SGL,     0 = CH0  , 0   , 0, 0, 0 = 96d</span>
    <span class="c"># 0, 1,    1=SGL,     1 = CH1  , 0   , 0, 0, 0 = 112d</span>
    <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="n">b01100000</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="n">b01110000</span>

    <span class="n">spi_data</span> <span class="o">=</span> <span class="n">spi</span><span class="o">.</span><span class="n">xfer2</span><span class="p">([</span><span class="n">cmd</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="c"># send hi_byte, low_byte; receive hi_byte, low_byte</span>

    <span class="c"># receive data range: 000..3FF (10 bits)</span>
    <span class="c"># MSB first: (set control bit in cmd for LSB first)</span>
    <span class="c"># spidata[0] =  X,  X,  X,  X,  X,  0, B9, B8</span>
    <span class="c"># spidata[1] = B7, B6, B5, B4, B3, B2, B1, B0</span>
    <span class="c"># LSB: mask all but B9 &amp; B8, shift to left and add to the MSB</span>
    <span class="n">adc_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">spi_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">spi_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">adc_data</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"MCP3002 Single Ended CH0,CH1 Read of the 3V3V Pi Supply"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"SPI max sampling speed = {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spi_max_speed</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"V-Ref = {0}, Resolution = {1}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vref</span><span class="p">,</span> <span class="n">resolution</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"SPI device = {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CE</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"-----------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="n">read_mcp3002</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">read_mcp3002</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>


<span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span> <span class="c"># Ctrl-C</span>
    <span class="n">spi</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre></figure>

<p>run it, and you should see output like this:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MCP3002 Single Ended CH0 Read of the 3V3 Pi Supply
SPI max sampling speed <span class="o">=</span> 1000000
V-Ref <span class="o">=</span> 3300.0, Resolution <span class="o">=</span> 1024
SPI device <span class="o">=</span> 0
<span class="nt">-----------------------------</span>

<span class="o">(</span>0,0<span class="o">)</span>
<span class="o">(</span>0,0<span class="o">)</span>
<span class="o">(</span>0,0<span class="o">)</span>
<span class="o">(</span>1,0<span class="o">)</span>
<span class="o">(</span>0,0<span class="o">)</span>
<span class="o">(</span>0,2<span class="o">)</span>
<span class="o">(</span>0,0<span class="o">)</span>
<span class="o">(</span>0,0<span class="o">)</span></code></pre></figure>

<p>Since no current is flowing through the CH0 and CH1 pins, they are essentially at zero volts. There can be some error in the measurement, but it‚Äôs close enough.</p>

<h3 id="measuring-some-voltage">Measuring Some Voltage</h3>

<p>Cool, now let‚Äôs see the high end of the scale. We can measure up to 3.3V. Let‚Äôs hook up CH0 to the 3V3 rail with a 10kOhm resistor to prevent damaging the Pi:</p>

<p><img src="/images/washerdryerbot/mcp3002_ch0_3v3.png" alt="" /></p>

<p>Measure again:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MCP3002 Single Ended CH0 Read of the 3V3 Pi Supply
SPI max sampling speed <span class="o">=</span> 1000000
V-Ref <span class="o">=</span> 3300.0, Resolution <span class="o">=</span> 1024
SPI device <span class="o">=</span> 0
<span class="nt">-----------------------------</span>

<span class="o">(</span>1023,0<span class="o">)</span>
<span class="o">(</span>1023,0<span class="o">)</span>
<span class="o">(</span>1023,0<span class="o">)</span>
<span class="o">(</span>1023,0<span class="o">)</span>
<span class="o">(</span>1023,0<span class="o">)</span>
<span class="o">(</span>1023,0<span class="o">)</span>
<span class="o">(</span>1023,0<span class="o">)</span></code></pre></figure>

<p>Cool, we‚Äôve measured the top of the range and the bottom of the range!</p>

<p>Let‚Äôs measure some real voltage from the CT sensor:</p>

<p><img src="/images/washerdryerbot/mcp3002_1jack.png" alt="" /></p>

<p>Now, the CT sensor is connected to GND across a 68 Ohm resistor. When no current flows through the CT sensor, we will read 0V. We put the CT sensor around a 12A space heater and echo the output of the measure program to text:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">python measure.py <span class="o">&gt;&gt;</span> heater.txt</code></pre></figure>

<p>I took that and plotted it in Excel:</p>

<p><img src="/images/washerdryerbot/heater_before_vdiv.png" alt="" /></p>

<p>One thing to notice is that we‚Äôre only getting half of the information about the AC wave. This is because when the wave is at its peak, we‚Äôre pushing voltage toward the GND pin. When the wave is in a trough, it‚Äôs trying to push voltage back toward the 3V3 pin to no avail and the MCP3002 still reads it as 0V.</p>

<p>We need to get the steady-state voltage up to a higher amount so that we can still read a positive voltage with the MCP3002. How about halfway?</p>

<h3 id="voltage-divider">Voltage Divider</h3>

<p>Resistors create something called a ‚Äúvoltage drop‚Äù which is <a href="http://physics.stackexchange.com/questions/55948/i-dont-understand-what-we-really-mean-by-voltage-drop">some EE wizardry that I don‚Äôt understand</a>. Take it for granted that when you have a resistor, the voltage on one terminal is measurably and proportionally different to the voltage on the other terminal. We can exploit this principle to put our circuit at that ‚Äústeady state‚Äù I mentioned before.</p>

<p>By connecting two resistors in series and then measuring the voltage in between them, we can obtain a desired voltage that is a specific fraction of the input voltage. This arrangement is called a voltage divider.</p>

<p><a href="https://learn.sparkfun.com/tutorials/voltage-dividers">Here‚Äôs a good resource for learning more about voltage dividers</a></p>

<p>From the equations there, we postulate that <strong>if we have 2 resistors of equal resistance connected in series, then the voltage between them will be exactly half the input voltage</strong>.</p>

<p><img src="https://cdn.sparkfun.com/assets/5/4/6/4/7/514208cace395fd711000000.png" alt="" width="300px" />
<em>R1 = R2 = 100kOhm</em></p>

<p>I‚Äôll use 100kOhm resistors to lessen the amount of current this circuit will drain from the Pi in case I use a battery pack.</p>

<p><img src="/images/washerdryerbot/mcp3002_vdiv.png" alt="" /></p>

<p>Let‚Äôs measure the heater again:</p>

<p><img src="/images/washerdryerbot/heater_after_vdiv.png" alt="" width="600px" /></p>

<p>Cool. We can now see the full AC sine wave of this space heater - which is an ideal resistive load, always using a consistent amount of power. You‚Äôll noticed it‚Äôs centered around 1/2 of our 10-bit scale: 511.5.</p>

<p>How about something that‚Äôs not a perfect load?</p>

<p><img src="/images/washerdryerbot/macbook_charger.png" alt="" width="600px" /></p>

<p>‚Ä¶neat.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/11/22/washerbot-and-dryerbot-part-2/">
        WasherBot and DryerBot, Part 2: Current Sensors and Burden Resistors
      </a>
    </h1>

    <span class="post-date">22 Nov 2016</span>

    <h3 id="table-of-contents">Table of Contents</h3>

<ul>
  <li><a href="/2016/11/21/washerbot-and-dryerbot-part-1/">Part 1: How to Tell If an Appliance Is Running</a></li>
  <li><a href="/2016/11/22/washerbot-and-dryerbot-part-2/">Part 2: Current Sensors and Burden Resistors</a></li>
  <li><a href="/2016/12/03/washerbot-and-dryerbot-part-3/">Part 3: Connecting to the Pi and Building a Voltage Divider</a></li>
  <li><a href="/2016/12/09/washerbot-and-dryerbot-part-4/">Part 4: A Low-Pass Filter and Reading From Laundry Appliances</a></li>
  <li><a href="/2017/04/24/washerbot-and-dryerbot-part-5/">Part 5: A Measurement Algorithm and Text Message Integration</a></li>
</ul>

<p>As you read in <a href="/2016/11/21/washerbot-and-dryerbot-part-1/">Part 1</a>, I‚Äôve now got a plan to get my washer and dryer to talk to me.</p>

<ol>
  <li>Clip a CT sensor to the power line.</li>
  <li>Hook the CT sensor up to an analog-to-digital converter</li>
  <li>Connect that ADC to a Raspberry Pi</li>
  <li>Write some software for the Pi to measure power consumption and notify me.</li>
</ol>

<p>Off to SparkFun.com for some parts.</p>

<p>First, 2 CT sensors to measure our current. 30 amps should be fine:
<a href="https://www.sparkfun.com/products/11005"><strong>Non-Invasive Current Sensor - 30A</strong>
<img src="https://cdn.sparkfun.com//assets/parts/6/2/6/2/11005-01a.jpg" alt="Non-Invasive Current Sensor - 30A" width="300px" /></a></p>

<p>You‚Äôll notice that these come with 3.5mm TRS plugs on the end. This will make them easy to plug in and remove, but now I need a jack to receive them.
<a href="https://www.sparkfun.com/products/11570"><strong>SparkFun TRRS 3.5mm Jack Breakout</strong>
<img src="https://cdn.sparkfun.com//assets/parts/7/5/4/6/11570-01.jpg" alt="SparkFun TRRS 3.5mm Jack Breakout" width="300px" /></a></p>

<p>These jacks come already assigned to a breakout board, which will make it convenient to use them with a breadboard - once some headers are soldered on:
<a href="https://www.sparkfun.com/products/116"><strong>Break Away Headers - Straight</strong>
<img src="https://cdn.sparkfun.com//assets/parts/1/0/6/00116-02-L.jpg" alt="Break Away Headers - Straight" width="300px" /></a></p>

<p>Lastly, I actually need to buy the ADC mentioned in part 1:
<a href="https://www.sparkfun.com/products/8636"><strong>Analog to Digital Converter - MCP3002</strong>
<img src="https://cdn.sparkfun.com//assets/parts/1/7/7/0/08636-03-L.jpg" alt="Analog to Digital Converter - MCP3002" width="300px" /></a></p>

<h3 id="soldering">Soldering</h3>

<p>Once the parts arrived, I needed to solder the header pins onto the jack breakout for attaching to the breadboard. I‚Äôd never soldered delicate electronics, only larger wires so I picked up some 0.32 solder and watched <a href="https://www.youtube.com/watch?v=f95i88OSWB4">some tutorials</a>.</p>

<p><img src="/images/washerdryerbot/solder_plug.jpg" alt="soldering headers onto the jack" /></p>

<p>With the parts soldered and prepared, it‚Äôs time to start measuring.</p>

<h3 id="measuring-current">Measuring Current</h3>

<p>So a little math here. According to the <a href="http://cdn.sparkfun.com/datasheets/Sensors/Current/ECS1030-L72-SPEC.pdf">datasheet</a>, our current sensor has a 2000-turn ratio. This means a current of 30 Amps, divided by 2000 turns, will yield a resultant current of 15mA. What voltage will that current be at? Well, theoretically, <a href="http://electronics.stackexchange.com/a/151317">an infinite voltage</a> (I don‚Äôt quite understand why this is, but I trust the opinion of people smarter than me). If you just hook the CT up to a multimeter, that meter will have resistance in the circuit and so you‚Äôll get a ‚Äúvoltage drop‚Äù across the two leads of the multimeter.</p>

<p>And so we get to measuring a 100-Watt lightbulb with just the multimeter hooked to it for a test. Turns out, with a measly 0.8 A of current, we‚Äôre already up to 2V. This won‚Äôt do. I need a way to get the voltage down further.</p>

<h3 id="burden-resistor">Burden Resistor</h3>

<p>To get the voltage down further, I learned I need to use a <a href="https://openenergymonitor.org/emon/buildingblocks/ct-sensors-interface">burden resistor</a>. This is a resistor with a very specific resistance that matches your circuit in order to get to an expected voltage range. <a href="https://openenergymonitor.org/emon/buildingblocks/ct-sensors-interface">This site has some great details and an Excel-based calculator for burden resistor resistance</a>.</p>

<p>The key bit is that our maximum measurable voltage is 3.3V - that‚Äôs the potential we‚Äôre feeding into the MCP3002. Since we‚Äôre measuring AC current, it means that 3.3V is the peak-to peak meaning that we actually want to measure a max of <strong>1.65V</strong> as our zero-point or reference point. At the maximum peak of the AC wave, we‚Äôll have 1.65V reference + 1.65V from the sensor = 3.3V. At the minimum trough of the AC wave, we‚Äôll have 1.65V - 1.65V = 0V.</p>

<p>The equation for burden resistor calculation is:</p>

<p><img src="/images/washerdryerbot/eqn1.gif" alt="" /></p>

<p>With a 30A current, we‚Äôd have a burden resistor value of 38.8 Ohms.</p>

<p><img src="/images/washerdryerbot/eqn2.gif" alt="" /></p>

<p>Since RadioShack had <strong>68</strong> Ohms as the closest resistor value (heh), I can actually measure up to 17A safely:</p>

<p><img src="/images/washerdryerbot/eqn3.gif" alt="" /></p>

<p>So we have a circuit that won‚Äôt overvolt the Pi! In part 3, we‚Äôll hook the sensor up to the Pi and start measuring it.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/11/21/washerbot-and-dryerbot-part-1/">
        WasherBot and DryerBot, Part 1: How to Tell If an Appliance Is Running
      </a>
    </h1>

    <span class="post-date">21 Nov 2016</span>

    <p>The time indicators on my washer and dryer are notoriously unreliable. Also, my and Mel‚Äôs busy brains occasionally forget that we started doing laundry. I wanted to build a system that would <strong>text me when my washer or dryer finished running</strong>.</p>

<h3 id="table-of-contents">Table of Contents</h3>

<ul>
  <li><a href="/2016/11/21/washerbot-and-dryerbot-part-1/">Part 1: How to Tell If an Appliance Is Running</a></li>
  <li><a href="/2016/11/22/washerbot-and-dryerbot-part-2/">Part 2: Current Sensors and Burden Resistors</a></li>
  <li><a href="/2016/12/03/washerbot-and-dryerbot-part-3/">Part 3: Connecting to the Pi and Building a Voltage Divider</a></li>
  <li><a href="/2016/12/09/washerbot-and-dryerbot-part-4/">Part 4: A Low-Pass Filter and Reading From Laundry Appliances</a></li>
  <li><a href="/2017/04/24/washerbot-and-dryerbot-part-5/">Part 5: A Measurement Algorithm and Text Message Integration</a></li>
</ul>

<p>When I last ran into a <a href="/2013/10/24/homebrew-temperature-monitoring/">problem that would require this kind of measurement</a>, I turned to some <a href="http://www.pcsensor.com/usb-thermometers.html">preassembled USB temperature sensors</a> and solved the problem with software only.</p>

<p>While searching for some hardware to help me tell if my washer or dryer were running, I came up empty - it seems like any prefab way to measure this would involve either buying a new washer and dryer or buying expensive hardware. I therefore decided to make my first foray into electronics hardware.</p>

<h3 id="how-to-tell-if-an-appliance-is-running">How to Tell If an Appliance Is Running</h3>

<p>The first part of getting my washer to text me that it‚Äôs done is to tell when it is running. I thought of a few ways to do this:</p>

<ol>
  <li>
    <p>Tap into the circuitry of the appliance and check if a certain part is running. This will work well for ‚Äúsmart‚Äù appliances with circuit boards, but would require messing around inside the washer/dryer, possibly voiding my warranty, and needing to come up with a new method if I get a new washer/dryer.</p>
  </li>
  <li>
    <p>Sense vibration the way that a few other online solutions do. This seemed highly error-prone to me.</p>
  </li>
  <li>
    <p>Measure the power consumption of the appliance with a Hall effect sensor. If the appliance is consuming power, consider it ‚Äúrunning.‚Äù This would involve putting a sensor inline with the power cable feeding an appliance, such as the <a href="https://www.amazon.com/Current-Sensor-Module-ACS712-Electronic/dp/B00COD9GO2/ref=sr_1_5?ie=UTF8&amp;qid=1480265285&amp;sr=8-5&amp;keywords=ACS712">ACS712</a>. This is a more-attractive option because it‚Äôs a one-size-fits-all approach for both the washer and the dryer and could be extended to other appliances like a dishwasher or a rice cooker. The downside is that it involves interrupting the flow of power and messing with mains power, which is risky.
<a href="https://www.youtube.com/watch?v=UF5jrnXvTlM&amp;t=3m15s"><img src="/images/washerdryerbot/acs712_in_action.png" alt="The ACS712 in action" /></a></p>
  </li>
  <li>
    <p>Measure power as in option 2, but instead use a noninvasive current transformer sensor. This what whole-home monitoring solutions like <a href="https://www.neur.io/energy-monitor/">Neurio</a> use. Neurio is one of the premade options I considered, but it seems too unproven and new. CT sensors use a ring-shaped clamp that goes around one of the wires in the circuit. This has the benefit of being wholly separate from the mains current, making it safer.
<img src="/images/washerdryerbot/neurio.png" alt="Neurio uses 2 CT sensors" /></p>
  </li>
</ol>

<p>I opted to use a CT sensor. Since I already had a Raspberry Pi available, I decided I would use it as the platform for building my device. It has the benefit of being easy to program, running a full Linux desktop environment, and having tons of forum support online. Another option is to use an <a href="https://openenergymonitor.org/emon/buildingblocks/how-to-build-an-arduino-energy-monitor-measuring-current-only">Arduino</a>. In the future, I‚Äôd like to try migrating to a standalone, low-power board like the <a href="https://www.sparkfun.com/products/13711">ESP8266</a>.</p>

<p>CT sensors are very sensitive - they can measure current to a precise degree and can be used to tell exactly how much power you‚Äôre consuming. My needs are a lot simpler - I don‚Äôt need to know <em>how much</em> power is being consumed, just whether or not it is.</p>

<p>So here are the building blocks: a Raspberry Pi to run software and send text messages; current sensors to measure the power usage, and‚Ä¶something in the middle.</p>

<h3 id="something-in-the-middle">Something in the Middle</h3>

<p>One thing I quickly realized is that the Raspberry Pi does not have an analog input. Raspberry Pi‚Äôs inputs, called general-purpose-input-output or GPIO, can only tell whether a voltage is above a certain threshold (‚Äúhigh‚Äù) or below it (‚Äúlow‚Äù), because they are digital inputs.</p>

<p>Current sensors work by taking a high voltage current at high amperage and converting it down to a few milliamps of current at only a few volts. But since they are measuring <a href="https://learn.sparkfun.com/tutorials/alternating-current-ac-vs-direct-current-dc">alternating current</a>, the voltage will be rapidly switching signs back and forth:</p>

<p><img src="https://cdn.sparkfun.com/r/600-600/assets/learn_tutorials/1/1/5/AC_sinewave_1.png" alt="alternating current" /></p>

<p>Theoretically, I could have used the GPIO to measure this state with only 1 bit of resolution (very crude, only on or off). I wanted something a little more precise, and some Googling led me to an <a href="https://learn.adafruit.com/raspberry-pi-analog-to-digital-converters/overview">Analog to Digital Converter (ADC)</a>.</p>

<p>An ADC takes an analog signal and discretizes it - from an infinite number of values to specific steps. Since I wanted to measure 2 inputs (washer and dryer), I got a 2-channel ADC, the <a href="https://www.sparkfun.com/products/8636">MCP3002</a>. This chip has a 10-bit resolution, which gives you 1024 possible values instead of only 2. Much better.</p>

<p>Stay tuned for Part 2, in which I put together a parts list and get to soldering.</p>


  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>
    </div>

  </body>
</html>
