<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

<!--Facebook share tags -->
  <meta property="og:url"                content="/page3/" />
  <meta property="og:type"               content="article" />
  <meta property="og:title"              content="Home"/>
  <meta property="og:description"        content="" />
  <meta property="og:image"              content="" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Python Monty
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Ubuntu">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/f_favicon.png">
                                 <link rel="shortcut icon" href="/public/f_favicon.png">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0d">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
          <img src="https://avatars1.githubusercontent.com/u/6099983?v=3&s=460" height="200"/>
      <h1>
        <a href="/">
          Python Monty
        </a>
      </h1>
      <p class="lead">Explaining the terrible code I write as I go. Mostly in Python. Also some restaurant reviews and recipes.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive/">Archive</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    </nav>

    <p>&copy; 2018. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/08/22/sexy-pizza/">
        Sing a Song for Sixpence
      </a>
    </h1>

    <span class="post-date">22 Aug 2015</span>

    <p>I’ve been wanting to do this for some time, and I think I’m taking the plunge - you’ll start seeing restaurant reviews on here as well as code.</p>

<p>##Four and Twenty, East Johnson, Madison##</p>

<p>To start with, I can’t believe I’ve never been here. Well, actually, it stands to reason - Four and Twenty stands in a tiny commercial space amid tightly-knit ranch houses and sandwiched between the thoroughfares of East Wash and Packers Ave, so it’s easy to drive right on past and not give it a second thought.</p>

<p>To do so would be a mistake. Mel and I were on our way to an art fair in the neighborhood and she commented that her friend Phil sometimes works here. We were looking for something small and quick to eat, and Four and Twenty fit the bill.</p>

<p>The cafe is small with big windows out onto a soccer field and a concrete patio with planters - in summer it’s flooded with light, which illuminates all the imperfections (and the artwork) inside. The swinging doors to the kitchen don’t completely block its view, nor that of the supply room, giving it a just-moved in feel.</p>

<p>Mel and I ordered breakfast sandwiches, and they were probably my ideal quick brunch if I could ever describe it. I had an egg and cheddar with spinach and sauteed mushrooms, on the second-best biscuit I’ve ever had (that honor goes to Third &amp; Hollywood in Columbus). The biscuit was big and firm. It didn’t flake off in layers or crumble in little ball-bearings of dough - it held together and didn’t stick my tongue to the roof of my mouth. This biscuit is definitely something to write home about. A small cup of fruit accompanied the sandwich and made for a well-priced, well-portioned breakfast that didn’t make me want to nap afterward.</p>

<p>I should also mention my drink, since it was even better than my sandwich - props to Phil. An iced chai latte with a rich milkiness that I’m often lacking. It was understated and sweet and I’d like to have another soon.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/01/16/a-homegrown-recipe-app-that-helps-you-cook/">
        A Homegrown Recipe App That Helps You Cook
      </a>
    </h1>

    <span class="post-date">16 Jan 2015</span>

    <p>I do love to cook. All of my favorite recipes are stored in my head, are improvised off the cuff, or found in a gross stack of crinkled papers held together with a binder clip in my cabinet.</p>

<p>I do a lot of looking up recipes online, but every recipe website I’ve seen has a big flaw. These sites are not designed to help you actually read the recipe. They are designed to keep you clicking around, keep you sharing recipes on social media, keep you seeing ads.</p>

<p>I wanted a recipe app that would just show me what I needed to gather and how to put it together to cook it all. In the meantime, I decided it wouldn’t hurt it if were also pretty to look at. Lastly, I wanted it optimized for use on an iPad so that I could keep it close at hand while actually cooking.</p>

<p><img src="https://raw.githubusercontent.com/z3ugma/rethink-recipes/master/screenshot1.png" alt="Finished Recipes Webapp" /></p>

<h2 id="technical-design">Technical Design</h2>

<p>Python is my pet language, and I wanted a database that would be easy to use with native Python types. Recipes are well-suited to a document-oriented store - each recipe has highly-variable ingredients. The only potential advantage I could see for a relational db would be to answer queries like “show me all the recipes with onion as an ingredient”. 
<a href="http://www.rethinkdb.com">RethinkDB</a> is great because it has a native web interface and a <a href="http://www.rethinkdb.com/docs/introduction-to-reql/">cool query language</a> called ReQL.</p>

<p>I used Python and Flask to write the app, and Tornado to make it easy to deploy - I can never seem to get uWSGI or Gunicorn working correctly.</p>

<h2 id="frontend-design">Frontend Design</h2>

<p>Two design elements set Rethink Recipes apart:</p>

<ol>
  <li>
    <p>When a recipe is entered, the app finds the top 8 Google Images hits for the title of the recipe. It uses the colors found in these images to calculate a <strong>unique, indivualized color palette</strong> for each recipe.</p>
  </li>
  <li>
    <p>Whenever an ingredient appears verbatim in the directions, it is <strong>highlighted</strong> in the directions. This makes it easy to scan the directions for the step you should be on next.</p>
  </li>
</ol>

<h2 id="app-routes">App Routes</h2>

<p>Here are the nuts and bolts of how Rethink Recipes works:</p>

<h3 id="adding-a-recipe">Adding a Recipe</h3>

<p><img src="https://raw.githubusercontent.com/z3ugma/rethink-recipes/master/screenshot3.png" alt="Adding a Recipe" /></p>

<p>When accessing <code>/add</code>, the user is presented with 3 form fields - the title, ingredients, and directions.</p>

<p>When the form is submitted, a bunch of things happen:</p>

<ol>
  <li>The title of the recipe is joined with + signs. i.e. “Foo bar baz pancakes” -&gt; “foo+bar+baz+pancakes”. This is the format the Google Images api receives queries in.</li>
  <li>A Google Image API query returns a list of URLs pointing to Google Images thumbnails.</li>
  <li>A Python module called Colorific, which uses PIL (the Python Image Library), extracts the most prominent colors from each image, 5 colors per image. (I also wrote my own module to do this processing, but Colorific was already packaged and easy to install. )</li>
  <li>We’re left with a list of RGB tuples. 5 colors per images times 8 images = 40 tuples long.</li>
  <li>The Lightness value of each tuple is calculated (conversion to HSV color space), and the list is reordered in order of darkest to lightest.</li>
  <li>The list is split into 4 smaller lists of 10 elements each. This roughly groups the colors into the 10 darkest, 10 next darkest, etc.</li>
  <li>The average value of the 10 RGB tuples in each list is calculated. We end up with 4 tuples to store to the db along with the recipe.</li>
  <li>The URL title is “slugified” - stripping out spaces and non alphanumeric punctuation to make a nice URL slug</li>
  <li>The ingredients list is calculated. For each line in the ingredients box:
    <ul>
      <li>Split on spaces. The first 2 pieces are the amount - “1 cup” for example.</li>
      <li>Everything after the amount is the “what”</li>
    </ul>
  </li>
  <li>The directions list is each line of input in the dirctions box</li>
  <li>All this data is formed into a Python dictionary:
    <ul>
      <li>Title, URLs of image thumbs, ingredients, directions, slug, and average colors.</li>
    </ul>
  </li>
  <li>Ingredients and directions are sanitized for disallowed entries (like null string)</li>
  <li>This Python dict is inserted into RethinkDB.</li>
  <li>The user is redirected to the newly-created recipe.</li>
</ol>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_gimages</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">'https://ajax.googleapis.com/ajax/services/search/images?v=1.0&amp;q=</span><span class="si">%</span><span class="s">s&amp;start=</span><span class="si">%</span><span class="s">d&amp;imgsz=large&amp;imgtype=photo'</span> <span class="o">%</span> <span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">())[</span><span class="s">'responseData'</span><span class="p">][</span><span class="s">'results'</span><span class="p">]:</span>
             <span class="n">answer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="s">'tbUrl'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">answer</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/add'</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">RecipeForm</span><span class="p">()</span>
    <span class="c">#form.ingredients.data = "1c ingredient\nenter ingredients here  "</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>

        <span class="n">lightness</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rainbow</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resp</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="n">get_gimages</span><span class="p">(</span><span class="s">"+"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">quiche</span> <span class="o">=</span> <span class="n">colorific</span><span class="o">.</span><span class="n">extract_colors</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">max_colors</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">each</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">quiche</span><span class="o">.</span><span class="n">colors</span><span class="p">])</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="p">[(</span><span class="n">m</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.299</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.587</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.114</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">]</span>
        <span class="n">lightness</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lightness</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lightness</span><span class="p">]</span>
        <span class="n">lightness</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">rgb_to_hsv</span><span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">(</span><span class="n">lightness</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">avg</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">each</span><span class="p">)))</span>
            <span class="n">rainbow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg</span><span class="p">)</span>

        <span class="n">slug</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">recipe</span> <span class="o">=</span> <span class="p">{</span> <span class="s">'title'</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span> <span class="s">'ingredients'</span><span class="p">:</span> <span class="p">[{</span><span class="s">'amount'</span><span class="p">:</span> <span class="s">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ingredient</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]),</span> <span class="s">'what'</span><span class="p">:</span> <span class="s">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ingredient</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:])}</span> <span class="k">for</span> <span class="n">ingredient</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">ingredients</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)],</span> <span class="s">'directions'</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">directions</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\r\n</span><span class="s">'</span><span class="p">),</span> <span class="s">'urls'</span><span class="p">:</span> <span class="n">urls</span><span class="p">,</span> <span class="s">'slug'</span><span class="p">:</span> <span class="n">slug</span><span class="p">,</span> <span class="s">'avgcolors'</span><span class="p">:</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rainbow</span><span class="p">]}</span>

        <span class="n">recipe</span><span class="p">[</span><span class="s">'ingredients'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">recipe</span><span class="p">[</span><span class="s">'ingredients'</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="p">[</span><span class="s">'what'</span><span class="p">]</span><span class="o">==</span><span class="s">''</span><span class="p">]</span>
        <span class="n">recipe</span><span class="p">[</span><span class="s">'directions'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">recipe</span><span class="p">[</span><span class="s">'directions'</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">==</span><span class="s">''</span><span class="p">]</span>

        <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">'recipes'</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">recipe</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'recipe'</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">slug</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"add.html"</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span></code></pre></figure>

<h3 id="editing-a-recipe">Editing a Recipe</h3>
<p>The same form from /add is rendered, with the data from the existing recipe filled in. Once the form is submitted, the same process as adding happens. Instead of inserting the new recipe, however, the existing recipe’s record is updated.</p>

<p>The slug of the recipe appears in the URL of the page. We use that slug to get the first recipe in the db that matches that slug. Note that there’s no guarantee of uniqueness for a slug - RethinkDB doesn’t have unique indexing.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/&lt;query&gt;/edit'</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>


    <span class="n">form</span> <span class="o">=</span> <span class="n">RecipeForm</span><span class="p">()</span>
    <span class="n">recipe</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">'recipes'</span><span class="p">)</span><span class="o">.</span><span class="nb">filter</span><span class="p">({</span><span class="s">'slug'</span><span class="p">:</span> <span class="n">query</span><span class="p">})</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">recipe</span><span class="p">:</span>
        <span class="n">recipe</span> <span class="o">=</span> <span class="n">recipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'GET'</span><span class="p">:</span>

        <span class="n">form</span><span class="o">.</span><span class="n">ingredients</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="o">.</span><span class="n">join</span><span class="p">([(</span><span class="n">i</span><span class="p">[</span><span class="s">'amount'</span><span class="p">]</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">i</span><span class="p">[</span><span class="s">'what'</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">recipe</span><span class="p">[</span><span class="s">'ingredients'</span><span class="p">]])</span>
        <span class="n">form</span><span class="o">.</span><span class="n">directions</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">recipe</span><span class="p">[</span><span class="s">'directions'</span><span class="p">])</span>
        <span class="n">form</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">recipe</span><span class="p">[</span><span class="s">'title'</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"edit.html"</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">recipe</span><span class="o">=</span><span class="n">recipe</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python">        <span class="nb">id</span> <span class="o">=</span> <span class="n">recipe</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span>

        <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">'recipes'</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">recipe</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'recipe'</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">slug</span><span class="p">))</span></code></pre></figure>

<h3 id="deleting-a-recipe">Deleting a Recipe</h3>

<p><img src="https://raw.githubusercontent.com/z3ugma/rethink-recipes/master/screenshot4.png" alt="Deleting a Recipe" /></p>

<p>The recipe’s slug is in the URL. The user clicks “Delete”, is prompted with a checkbox to confirm, and then recipes with slugs matching the URL are deleted:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/&lt;query&gt;/delete'</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">DeleteForm</span><span class="p">()</span>
    <span class="n">recipe</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">'recipes'</span><span class="p">)</span><span class="o">.</span><span class="nb">filter</span><span class="p">({</span><span class="s">'slug'</span><span class="p">:</span> <span class="n">query</span><span class="p">})</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">recipe</span><span class="p">:</span>
        <span class="n">recipe</span> <span class="o">=</span> <span class="n">recipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'GET'</span><span class="p">:</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"delete.html"</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">recipe</span><span class="o">=</span><span class="n">recipe</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">'deleterecipe'</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>

            <span class="nb">id</span> <span class="o">=</span> <span class="n">recipe</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span>

            <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">'recipes'</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'index'</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">"Are you sure? Check the box"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"delete.html"</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">recipe</span><span class="o">=</span><span class="n">recipe</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span></code></pre></figure>

<h3 id="displaying-a-recipe">Displaying a Recipe</h3>

<p>When a recipe’s slug appears alone in the URL, the recipe is displayed.</p>

<p>The first recipe in the db with a matching slug is displayed. We take the “what” from each ingredient, and only take the portion before a comma. This allows for things like “onions, diced” to appear in the recipe, but still highlight the word “onions” in the directions. If the word appears in the directions, then the word in the directions is wrapped in kbd tags, which stand out in Bootstrap.</p>

<p>You’ll recall that each recipe has 8 URLs of Google images and 4 RBG tuples of colors to use in displaying the page. When the page is rendered, the darkest of the RGB colors is used as the background of the header, the lightest is used for the page background and header text, and the 2nd darkest is used for the panel headers. The 4th one is reserved for future use.</p>

<p>Along with the 8 Google images thumbnails in place, this makes each recipe page have the unique colors corresponding to the food you’re making! So a raspberry pie has bright reds and rich tans, and a chili recipe has lots of earthy tones.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/&lt;query&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">recipe</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">recipe</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">'recipes'</span><span class="p">)</span><span class="o">.</span><span class="nb">filter</span><span class="p">({</span><span class="s">'slug'</span><span class="p">:</span> <span class="n">query</span><span class="p">})</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">rdb_conn</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">recipe</span><span class="p">:</span>
        <span class="n">recipe</span> <span class="o">=</span> <span class="n">recipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">recipe</span><span class="p">[</span><span class="s">'directions'</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="s">'what'</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">","</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">recipe</span><span class="p">[</span><span class="s">'ingredients'</span><span class="p">]]:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="s">"&lt;kbd&gt;"</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="s">"&lt;/kbd&gt;"</span><span class="p">))</span>
        <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Markup</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="n">rainbow</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">recipe</span><span class="p">[</span><span class="s">'avgcolors'</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"recipes.html"</span><span class="p">,</span> <span class="n">urls</span> <span class="o">=</span> <span class="n">recipe</span><span class="p">[</span><span class="s">'urls'</span><span class="p">],</span> <span class="n">avg</span><span class="o">=</span><span class="n">rainbow</span><span class="p">,</span> <span class="n">ingredients</span> <span class="o">=</span> <span class="n">recipe</span><span class="p">[</span><span class="s">'ingredients'</span><span class="p">],</span> <span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">recipe</span><span class="p">[</span><span class="s">'title'</span><span class="p">],</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span></code></pre></figure>

<p>The end result of this is an iPad-optimized recipe database, customizable for your own personal recipes. Not great for importing directly from recipe sites, but great for saving your time-tested recipes in a user-friendly format.</p>

<p>###Futures###</p>

<p>I would like to expand this to being multi-user. I think each user would get their own RethinkDB table, and add a users table with hashed passwords.</p>

<p>###Check It Out###
You can download and set it up for yourself in a virtual machine - see the <a href="https://github.com/z3ugma/rethink-recipes">Github repo for the project</a></p>

<p>You can also see my local copy of the app, at <a href="http://z3ugma.zzzz.io:5025">http://z3ugma.zzzz.io:5025</a>. Feel free to add your own recipes, but don’t delete mine :)</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/01/16/delicious-vegan-biscuits-and-gravy-copy/">
        Delicious Vegan Biscuits and Gravy
      </a>
    </h1>

    <span class="post-date">16 Jan 2015</span>

    <p>Next up, a departure from my usual programming entries to another hobby - cooking.</p>

<p>It’s <a href="http://www.veganuary.com">Veganuary</a>! It’s a month of sacrifice for me, in the name of shedding holiday pounds.</p>

<p>The single hardest thing for me about going vegan is finding quick meals to make that aren’t a piece of fruit.</p>

<p>I think it’s similar to when I stopped eating meat. At first, I started cooking the same old meals, just with the meat removed and a vegetable or mushrooms substituted. These sometimes felt lacking. Over time, I learned to cook “natively veggie” meals - meals that were vegetarian from the start, whose flavors melded and combined deliciously without the need for meat.</p>

<p>Now that I’m not eating dairy or cheese, I find my usual meals lacking - because there’s no dairy or cheese. It will take some time to learn to cook “natively vegan”, I’m sure.</p>

<p>In the meantime, however, here’s an amazing, hearty, breakfast, that’s totally vegan.</p>

<h1 id="vegan-biscuits-and-gravy">Vegan Biscuits and Gravy</h1>

<p><em>Serves 4</em></p>

<h2 id="ingredients">Ingredients</h2>

<ul>
  <li>12 oz Trader Joe’s Soy Chorizo</li>
  <li>1 medium yellow onion, diced</li>
  <li>1 green bell pepper, diced</li>
  <li>2 oz Earth Balance buttery vegan spread</li>
  <li>2 oz whole wheat flour</li>
  <li>1 Tbsp Better than Bouillon No-Beef Base</li>
  <li>Garlic Naan or vegan english muffins</li>
</ul>

<p>##Directions##</p>
<ol>
  <li>With a little olive oil, brown the chorizo, onions, and peppers in a large skillet. Once browned, move the mixture to one half of the pan.</li>
  <li>Melt the earth balance in the empty half of the pan. Add the flour and whisk lightly until a pasty consistency is achieved. Allow this roux to brown for a minute.</li>
  <li>Mix bouillon and 1 cup of water. Add to the roux a little bit at a time, whisking constantly until gravy-like. Mix the chorizo mixture in with the broth. Add water to thin to your liking.</li>
  <li>Toast the garlic naan or english muffin. Slice into thin wafers and top the bread with biscuits and gravy. Yum!</li>
</ol>

<p><img src="/images/vegan_gravy.jpg" alt="Vegan Biscuits and Gravy" /></p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/12/13/libusb-and-python-to-overcome-bad-usb-design/">
         LibUSB and Python to Overcome Bad USB Design
      </a>
    </h1>

    <span class="post-date">13 Dec 2014</span>

    <p><a href="http://z3ugma.github.io/2013/10/25/homebrew-temperature-monitoring/">Last October, I began recording temperatures</a> for my homebrew setup. It used a C program called pcsensor that someone reverse-engineered from the Windows version available on the CD that came with my TEMPer1v1.4 sensors.</p>

<p>The problem with these sensors is that they have no unique identifier - reading the value in from pcsensor with multiple sensors installed often resulted in the data series being mixed together, because there was no “order” to the way data was being read into the parser.</p>

<p>Here’s a demonstration of what I mean:</p>

<p><img src="/images/graphinterference.png" alt="Graph Interference" /></p>

<p>Notice how the order of the orange and red points switch a lot? This made it really difficult to analyze the temperatures in my setup, apart from using a human to look at the trendline created by the mix of points.</p>

<p>I spent some time trying to create a driver for these TEMPer sensors, but in the end I was able to find <a href="https://github.com/padelt/temper-python">one by Phillip Adelt that uses libusb and pyusb</a> - libraries that allow you to talk to USB devices with Python.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone https://github.com/padelt/temper-python.git
<span class="nb">cd </span>temper-python
<span class="nb">sudo </span>python setup.py <span class="nb">install</span></code></pre></figure>

<p>The ingenius thing that Phillip did was to determine the <em>port</em> and <em>bus</em> of each sensor - thus giving it a “unique ID” based on where it was physically plugged into the computer!</p>

<p>His module installs itself as “temperusb”, so I wrote a quick script to read the value of the sensors:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>
<span class="c"># encoding: utf-8</span>

<span class="kn">from</span> <span class="nn">temperusb</span> <span class="kn">import</span> <span class="n">TemperHandler</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">th</span> <span class="o">=</span> <span class="n">TemperHandler</span><span class="p">()</span>
<span class="n">devs</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_devices</span><span class="p">()</span>


<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">devs</span><span class="p">):</span>
    <span class="n">temps</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">get_temperature</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s">"fahrenheit"</span><span class="p">)</span>
    <span class="n">ports</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">get_ports</span><span class="p">()</span>
    <span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">get_bus</span><span class="p">()</span>
    <span class="k">print</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">ports</span><span class="p">,</span> <span class="n">temps</span><span class="p">)</span></code></pre></figure>

<p>Linux limits which users can access raw USB data, so we either need to install some <a href="http://www.reactivated.net/writing_udev_rules.html#example-pilot">udev rules</a> or run the script as superuser. Sudo is easiest for me. It outputs something like:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">fred@brewery:~$ sudo python temper_read.py
[sudo] password for fred:
(2, 2, 56.8625)
(2, 1, 22.1)
fred@brewery:~$</code></pre></figure>

<p>The bus and port will be consistent, even if the <em>order</em> of the entries gets switched. Now we can depend on the results of these sensors, and send them to InfluxDB:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>
<span class="c"># encoding: utf-8</span>

<span class="kn">from</span> <span class="nn">temperusb</span> <span class="kn">import</span> <span class="n">TemperHandler</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>

<span class="n">th</span> <span class="o">=</span> <span class="n">TemperHandler</span><span class="p">()</span>
<span class="n">devs</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_devices</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">influxdb</span> <span class="kn">import</span> <span class="n">InfluxDBClient</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">InfluxDBClient</span><span class="p">(</span><span class="s">'hostname'</span><span class="p">,</span> <span class="mi">8086</span><span class="p">,</span> <span class="s">'root'</span><span class="p">,</span> <span class="s">'root'</span><span class="p">,</span> <span class="s">'temperatures'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">devs</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span><span class="p">[]</span>
    <span class="n">ports</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">get_ports</span><span class="p">()</span>
    <span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">get_bus</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">"points"</span><span class="p">:[[</span><span class="n">i</span><span class="p">,</span> <span class="n">dev</span><span class="o">.</span><span class="n">get_temperature</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s">"fahrenheit"</span><span class="p">),</span> <span class="n">ports</span><span class="p">,</span> <span class="n">bus</span><span class="p">]],</span> <span class="s">"name"</span><span class="p">:</span> <span class="s">"</span><span class="si">%</span><span class="s">s_temper_</span><span class="si">%</span><span class="s">s_</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span><span class="n">ports</span><span class="p">,</span> <span class="n">bus</span><span class="p">),</span> <span class="s">"columns"</span><span class="p">:</span> <span class="p">[</span><span class="s">"index"</span><span class="p">,</span> <span class="s">"temperature"</span><span class="p">,</span> <span class="s">"port"</span><span class="p">,</span> <span class="s">"bus"</span><span class="p">]})</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">write_points</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"Couldn't connect to influxdb"</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">"Couldn't connect to InfluxDB"</span>
        <span class="k">print</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code></pre></figure>

<p>I put this in the superuser’s crontab:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>crontab <span class="nt">-e</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># m h  dom mon dow   command
* * * * * /usr/bin/python /home/fred/temper_influx.py</code></pre></figure>

<p>This sends the available temperatures to InfluxDB once a minute.</p>

<p>Which leaves me very happy with my temperature-monitoring setup:</p>

<p><img src="/images/grafana_temperatures.png" alt="Grafana Temperatures Dashboard" /></p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/12/13/influxdb-augments-my-homebrew-temperature-monitor/">
        InfluxDB Augments My Homebrew Temperature Monitor
      </a>
    </h1>

    <span class="post-date">13 Dec 2014</span>

    <p><a href="http://z3ugma.github.io/2013/10/25/homebrew-temperature-monitoring/">Last October, I began recording temperatures</a> for my homebrew setup. It was early in my explorations of Python and scripting, and ran in a pretty silly fashion. It went something like this:</p>

<ol>
  <li>Echo the output of a C program that read the temperatures into a log file</li>
  <li>Parse that logfile using python to create a JSON file for Google Charts to use</li>
  <li>Use PHP embedded in HTML via an AJAX callback function to parse that JSON file</li>
  <li>Display the result in Google Charts</li>
</ol>

<p>This was incredibly slow and process intensive when more than 1 week’s worth of data was captured, so I moved the log to a backup file weekly, leaving a blank file for the next week’s data.</p>

<p><a href="http://influxdb.com/">InfluxDB</a> has been <a href="http://www.xaprb.com/blog/2014/03/02/time-series-databases-influxdb/">getting a lot of buzz</a> on HackerNews lately. It is a time-series database, which means that the <a href="http://influxdb.com/docs/v0.8/introduction/getting_started.html#writing-and-exploring-data-in-the-ui">primary key</a> of any entry is the timestamp of when the data was entered into the database. Queries are done using a SQL-like syntax, but everything is oriented around time. Queries like “give me the last data value of every hour” and “what is the average value of this data point for the past 3 Wednesdays” are difficult to do with large data sets in a traditional SQL database, but InfluxDB is designed from the ground up to handle them.</p>

<p>For a future idea - how to join time-series data from Influx to regular relational data in MySQL? This is relevant for another project I’m currently working on. Keep an eye out for updates on that project as well.</p>

<p>What won me over to databases like InfluxDB and <a href="http://rethinkdb.com/">RethinkDB</a> is the simple, no-nonsense, easy-to-use web interface that comes ready right out of the box, and the SQL-like query language. Another big win for Influx was support from <a href="http://grafana.org/">Grafana</a>, a turnkey open-source time-series graphing platform, which I highly encourage you to check out.</p>

<p>I set up InfluxDB on a Vagrant VM on my Mac server, with the Vagrantfile like so:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># -*- mode: ruby -*-</span>
<span class="c1"># vi: set ft=ruby :</span>
<span class="c1"># encoding: utf-8</span>

<span class="c1"># Vagrantfile API/syntax version. Don't touch unless you know what you're doing!</span>
<span class="no">VAGRANTFILE_API_VERSION</span> <span class="o">=</span> <span class="s2">"2"</span>

<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
 <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s2">"hashicorp/precise64"</span>
 
 <span class="n">dirname</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="no">Dir</span><span class="p">.</span><span class="nf">getwd</span><span class="p">)</span>
 <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">hostname</span> <span class="o">=</span> <span class="n">dirname</span>

 <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">8083</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">8083</span>
 <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">8086</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">8086</span>
 <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">8090</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">8090</span>
 <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">8099</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">8099</span>
 <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"forwarded_port"</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">80</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">8089</span>


<span class="vg">$script</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="no">SCRIPT</span><span class="sh">
echo "Provisioning InfluxDB"
sudo apt-get update
sudo apt-get -y install python python-pip git curl upstart apache2

sudo pip install nest-thermostat influxdb python-forecastio

wget http://s3.amazonaws.com/influxdb/influxdb_latest_amd64.deb
sudo dpkg -i influxdb_latest_amd64.deb

wget http://grafanarel.s3.amazonaws.com/grafana-1.9.0.tar.gz
tar -xf grafana-1.9.0.tar.gz
sudo cp -R grafana-1.9.0/* /var/www/
sudo cp /vagrant/config.js /var/www/config.js
sudo chmod -R 777 /var/www

sudo service influxdb start

sudo initctl emit vagrant-ready
</span><span class="no">SCRIPT</span>

<span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">inline: </span><span class="vg">$script</span>
<span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">inline: </span><span class="s2">"export EDITOR=nano"</span><span class="p">,</span> <span class="ss">privileged: </span><span class="kp">false</span>
<span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">inline: </span><span class="s2">"(crontab -l 2&gt;/dev/null; echo </span><span class="se">\"</span><span class="s2">* * * * * /usr/bin/python /vagrant/nesttemp.py</span><span class="se">\"</span><span class="s2">) | crontab -"</span><span class="p">,</span> <span class="ss">privileged: </span><span class="kp">false</span>
<span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">inline: </span><span class="s2">"(crontab -l 2&gt;/dev/null; echo </span><span class="se">\"</span><span class="s2">*/2 * * * * /usr/bin/python /vagrant/forecastweather.py</span><span class="se">\"</span><span class="s2">) | crontab -"</span><span class="p">,</span> <span class="ss">privileged: </span><span class="kp">false</span>
<span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">inline: </span><span class="s2">"/usr/bin/python /vagrant/db_migrations.py"</span><span class="p">,</span> <span class="ss">privileged: </span><span class="kp">false</span>

<span class="k">end</span></code></pre></figure>

<p>This forwards the InfluxDB ports, port 80 for serving Grafana, installs influx, Grafana, and python dependencies, and sets up cron jobs (see below).</p>

<p>With InfluxDB running, the first step was to capture some data! Since I bought a Nest themostat, I figured that would be a good piece of time-series data to measure.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">nest_thermostat</span>
<span class="kn">import</span> <span class="nn">influxdb</span>

<span class="n">nest</span> <span class="o">=</span> <span class="n">nest_thermostat</span><span class="o">.</span><span class="n">Nest</span><span class="p">(</span><span class="s">"username"</span><span class="p">,</span> <span class="s">"password"</span><span class="p">)</span>
<span class="n">nest</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>
<span class="n">nest</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

<span class="n">temp</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">temp_out</span><span class="p">(</span><span class="n">nest</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s">"shared"</span><span class="p">][</span><span class="n">nest</span><span class="o">.</span><span class="n">serial</span><span class="p">][</span><span class="s">"current_temperature"</span><span class="p">])</span>
<span class="n">mode</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s">"shared"</span><span class="p">][</span><span class="n">nest</span><span class="o">.</span><span class="n">serial</span><span class="p">][</span><span class="s">"target_temperature_type"</span><span class="p">]</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">temp_out</span><span class="p">(</span><span class="n">nest</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s">"shared"</span><span class="p">][</span><span class="n">nest</span><span class="o">.</span><span class="n">serial</span><span class="p">][</span><span class="s">"target_temperature"</span><span class="p">])</span>

<span class="kn">from</span> <span class="nn">influxdb</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">influxdb</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">influxdb</span><span class="o">.</span><span class="n">InfluxDBClient</span><span class="p">(</span><span class="s">"localhost"</span><span class="p">,</span> <span class="mi">8086</span><span class="p">,</span> <span class="s">"root"</span><span class="p">,</span> <span class="s">"root"</span><span class="p">,</span> <span class="s">"temperatures"</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="s">"points"</span><span class="p">:[[</span><span class="n">temp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">mode</span><span class="p">]],</span>
   <span class="s">"name"</span><span class="p">:</span><span class="s">"nest"</span><span class="p">,</span>
   <span class="s">"columns"</span><span class="p">:[</span><span class="s">"temperature"</span><span class="p">,</span> <span class="s">"target_temperature"</span><span class="p">,</span> <span class="s">"type"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">]</span>
<span class="n">db</span><span class="o">.</span><span class="n">write_points</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code></pre></figure>

<p>Running this every minute via cron pulls the current temperature as well as the target temperature (what the thermostat is set to) into InfluxDB, through its easy-to-use but peculiarly-structured API.</p>

<p>I did the same thing with <a href="http://forecast.io/">Forecast.io</a>, my favorite weather API. This tells me the temperature outside my house:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">forecastio</span>

<span class="n">api_key</span> <span class="o">=</span> <span class="s">"#####################"</span>
<span class="n">lat</span> <span class="o">=</span> <span class="mf">43.05660</span>
<span class="n">lng</span> <span class="o">=</span> <span class="o">-</span><span class="mf">89.38337</span> 

<span class="n">forecast</span> <span class="o">=</span> <span class="n">forecastio</span><span class="o">.</span><span class="n">load_forecast</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lng</span><span class="p">)</span>

<span class="n">temp</span> <span class="o">=</span> <span class="n">forecast</span><span class="o">.</span><span class="n">hourly</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">temperature</span>


<span class="kn">from</span> <span class="nn">influxdb</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">influxdb</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">influxdb</span><span class="o">.</span><span class="n">InfluxDBClient</span><span class="p">(</span><span class="s">"localhost"</span><span class="p">,</span> <span class="mi">8086</span><span class="p">,</span> <span class="s">"root"</span><span class="p">,</span> <span class="s">"root"</span><span class="p">,</span> <span class="s">"temperatures"</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="s">"points"</span><span class="p">:[[</span><span class="n">temp</span><span class="p">]],</span>
   <span class="s">"name"</span><span class="p">:</span><span class="s">"forecastio_lakeside"</span><span class="p">,</span>
   <span class="s">"columns"</span><span class="p">:[</span><span class="s">"temperature"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">]</span>
<span class="n">db</span><span class="o">.</span><span class="n">write_points</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code></pre></figure>

<p>This required me to get a Forecast.io API key, with a limit of 1000 calls per day. That’s why I call it once every 2 minutes, for 720 calls per day.</p>

<p>The last part of setting up the VM is to perform database migrations - set up users and databases for the temperature data to go into:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">influxdb</span>

<span class="kn">from</span> <span class="nn">influxdb</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">influxdb</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">influxdb</span><span class="o">.</span><span class="n">InfluxDBClient</span><span class="p">(</span><span class="s">"localhost"</span><span class="p">,</span> <span class="mi">8086</span><span class="p">,</span> <span class="s">"root"</span><span class="p">,</span> <span class="s">"root"</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
	<span class="n">db</span><span class="o">.</span><span class="n">create_database</span><span class="p">(</span><span class="s">"grafana"</span><span class="p">)</span>
	<span class="n">db</span><span class="o">.</span><span class="n">create_database</span><span class="p">(</span><span class="s">"temperatures"</span><span class="p">)</span>
	<span class="n">db</span><span class="o">.</span><span class="n">switch_db</span><span class="p">(</span><span class="s">"temperatures"</span><span class="p">)</span>
	<span class="n">db</span><span class="o">.</span><span class="n">add_database_user</span><span class="p">(</span><span class="s">"temperatures"</span><span class="p">,</span> <span class="s">"password"</span><span class="p">)</span>
	<span class="n">db</span><span class="o">.</span><span class="n">set_database_admin</span><span class="p">(</span><span class="s">"temperatures"</span><span class="p">)</span>
	<span class="k">print</span> <span class="s">"Success"</span>
<span class="k">except</span><span class="p">:</span>
	<span class="k">print</span> <span class="s">"Influx DB Migrations Failed"</span>
	<span class="k">pass</span></code></pre></figure>


  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page4">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page2">Newer</a>
    
  
</div>
    </div>

  </body>
</html>
